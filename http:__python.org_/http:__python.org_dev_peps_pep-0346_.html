<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>PEP 346 -- User Defined ("with") Statements</title>
  <meta name="keywords" content="PEP 346 -- User Defined (&quot;with&quot;) Statements" />
  <meta name="description" content="PEP 346 -- User Defined (&quot;with&quot;) Statements" />
  <link rel="alternate" type="application/rss+xml" title="Community Events"
        href="http://www.python.org/channews.rdf" />
  <link rel="alternate" type="application/rss+xml" title="Python Recipes"
        href="http://aspn.activestate.com/ASPN/Cookbook/Python/index_rss" />
  <link rel="alternate" type="application/rss+xml" title="Usergroup News"
        href="http://python-groups.blogspot.com/feeds/posts/default" />
  <link rel="alternate" type="application/rss+xml" title="Python Screencasts"
        href="http://www.showmedo.com/latestVideoFeed/rss2.0?tag=python" />
  <link rel="alternate" type="application/rss+xml" title="Python Podcasts"
        href="http://www.awaretek.com/python/index.xml" />
  <link rel="alternate" type="application/rss+xml" title="Foundation News"
        href="http://feeds.feedburner.com/PythonSoftwareFoundationNews" />
  <link rel="alternate" type="application/rss+xml" title="Python Enhancement Proposals"
        href="http://www.python.org/dev/peps/peps.rss" />
  <link rel="alternate" type="application/rss+xml" title="Python Job Opportunities"
        href="http://www.python.org/community/jobs/jobs.rss" />
  <link rel="alternate" type="application/rss+xml" title="Reddit Feed of Python What's New Online"
        href="http://www.reddit.com/r/Python/.rss" />
  <link rel="alternate" type="application/rss+xml" title="Python Insider"
        href="http://feeds.feedburner.com/PythonInsider" />

  <link rel="stylesheet" type="text/css" media="screen" id="screen-switcher-stylesheet"
        href="/styles/screen-switcher-default.css" />
  <link rel="stylesheet" type="text/css" media="sc&#82;een"
        href="/styles/netscape4.css" />
  <link rel="stylesheet" type="text/css" media="print"
        href="/styles/print.css" />
  <link rel="alternate stylesheet" type="text/css" media="screen"
        href="/styles/largestyles.css" title="large text" />
  <link rel="alternate stylesheet" type="text/css" media="screen"
        href="/styles/defaultfonts.css" title="default fonts" />

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search under the www.python.org Domain"
        href="/search-pysite.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search within the Python Wiki"
        href="/search-pywiki.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search within Python Books at Google Book Search"
        href="/search-pybooks.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search within the Python Documentation"
        href="/search-pydocs.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search for a Module in the Standard Library"
        href="/search-pymodules.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search for Packages inside the Cheeseshop (PyPI)"
        href="/search-pycheese.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search Archives of the Main Python Mailing List"
        href="/search-pythonlist.xml"/>

  <script type="text/javascript" src="/js/iotbs2-key-directors-load.js"></script>
  <script type="text/javascript" src="/js/iotbs2-directors.js"></script>
  <script type="text/javascript" src="/js/iotbs2-core.js"></script>

</head>


<body>
  <!-- Logo -->
  <h1 id="logoheader">
    <a href="/" id="logolink" accesskey="1"><img id="logo" src="/images/python-logo.gif" alt="homepage" border="0" /></a>
  </h1>
  <!-- Skip to Navigation -->
  <div class="skiptonav"><a href="#left-hand-navigation" accesskey="2"><img src="/images/trans.gif" id="skiptonav" alt="skip to navigation" border="0" /></a></div>
  <div class="skiptonav"><a href="#content-body" accesskey="3"><img src="/images/trans.gif" id="skiptocontent" alt="skip to content" border="0" /></a></div>
  <!-- Utility Menu -->
  <div id="utility-menu">
    <!-- Search Box -->
    <div id="searchbox">
      <form method="get" action="http://google.com/search" id="searchform" name="searchform">
        <div id="search">
          <input type="hidden" id="domains" name="domains" value="www.python.org" />
          <input type="hidden" id="sitesearch" name="sitesearch" value="www.python.org" />
          <input type="hidden" id="sourceid" name="sourceid" value="google-search" />
          <input type="text" class="input-text" name="q" id="q" />
          <input type="submit" value="search" class="input-button" name="submit" id="submit" />
          <a href="/search" class="reference">Advanced Search</a>
        </div>
      </form>
    </div>
    <div id="screen-switcher"></div>
  </div>

  <div id="left-hand-navigation">
    <!-- Main Menu -->
    <div id="menu">
      <ul class="level-one">
            <li>
          <a href="/about/" title="About The Python Language">About</a>
        </li>
            <li>
          <a href="/news/" title="Major Happenings Within the Python Community">News</a>
        </li>
            <li>
          <a href="/doc/" title="Tutorials, Library Reference, C API">Documentation</a>
        </li>
            <li>
          <a href="/download/" title="Start Running Python Under Windows, Mac, Linux and Others">Download</a>
        </li>
            <li>
          <a href="/getit/" title="Alternate Download page for China">ä¸è½½</a>
        </li>
            <li>
          <a href="/community/" title="Mailing Lists, Jobs, Conferences, SIGs, Online Chats">Community</a>
        </li>
            <li>
          <a href="/psf/" title="Python Software Foundation">Foundation</a>
        </li>
            <li>
          <a href="http://docs.python.org/devguide/" title="Development of the Python language and website">Core Development</a>
        </li>
      </ul>
    </div>

    <!-- Quick Links -->
    <h4><a style="margin-top:1.5em" href="http://wiki.python.org/moin/">Python Wiki</a></h4>
    <h4><a style="margin-top:1.5em" href="http://blog.python.org/">Python Insider Blog</a></h4>
    <h4><a style="margin-top:1.5em" href="http://wiki.python.org/moin/Python2orPython3">Python 2 or 3?</a></h4>
    <h4><a style="color:#D58228; margin-top:1.5em" href="/psf/donations/">Help Fund Python</a></h4>
    <div style="align:center; padding-top: 0.5em; padding-left: 1em">
      <a href="/psf/donations/"><img width="116" height="42" src="/images/donate.png" alt="" title="" /></a>
    </div>
    <div style="align:center; padding-top: 0.5em; padding-left: 2.5em">
            <a href="http://wiki.python.org/moin/Languages"><img
	      style="align:center"
              width="94" height="46"
	      src="/images/worldmap.jpg" alt="[Python resources in languages other than English]" /></a>
    </div>
    <div style="align:center; padding-top: 0.0em; padding-left: 0em">
       <h4><a href="http://wiki.python.org/moin/Languages">Non-English Resources</a></h4>
    </div>
    <div class="calendar">
        <iframe src="https://www.google.com/calendar/embed?title=Release%20Schedule&amp;showNav=0&amp;showDate=0&amp;showPrint=0&amp;showTabs=0&amp;showCalendars=0&amp;showTz=0&amp;mode=AGENDA&amp;height=300&amp;wkst=1&amp;bgcolor=%23FFFFFF&amp;src=b6v58qvojllt0i6ql654r1vh00%40group.calendar.google.com&amp;color=%23B1365F&amp;" style=" border-width:0 " width="180" height="300" frameborder="0" scrolling="no">
            <a href="http://www.google.com/calendar/ical/b6v58qvojllt0i6ql654r1vh00%40group.calendar.google.com/public/basic.ics">
                Python Release Schedule iCal Calendar
            </a>
        </iframe>
    </div>
    <div class="calendar">
        <iframe src="https://www.google.com/calendar/embed?title=Events%20Calendar&amp;showNav=0&amp;showDate=0&amp;showPrint=0&amp;showTabs=0&amp;showCalendars=0&amp;showTz=0&amp;mode=AGENDA&amp;height=300&amp;wkst=1&amp;bgcolor=%23FFFFFF&amp;src=j7gov1cmnqr9tvg14k621j7t5c%40group.calendar.google.com&amp;color=%23B1365F&amp;" style=" border-width:0 " width="180" height="300" frameborder="0" scrolling="no">
            <a href="http://www.google.com/calendar/ical/j7gov1cmnqr9tvg14k621j7t5c%40group.calendar.google.com/public/basic.ics">
                Python Events iCal Calendar
            </a>
        </iframe>
        <p class="level-one"><a href="http://pycon.org/#calendar">Add an event</a> to this calendar.</p>
    </div>
    <div class="calendar">
        <iframe src="https://www.google.com/calendar/embed?title=User%20Group%20Calendar&amp;showNav=0&amp;showDate=0&amp;showPrint=0&amp;showTabs=0&amp;showCalendars=0&amp;showTz=0&amp;mode=AGENDA&amp;height=300&amp;wkst=1&amp;bgcolor=%23FFFFFF&amp;src=3haig2m9msslkpf2tn1h56nn9g%40group.calendar.google.com&amp;color=%23125A12&amp;" style=" border-width:0 " width="180" height="300" frameborder="0" scrolling="no">
            <a href="http://www.google.com/calendar/ical/3haig2m9msslkpf2tn1h56nn9g%40group.calendar.google.com/public/basic.ics">
                Python User Group iCal Calendar
            </a>
        </iframe>
        <p class="level-one"><a href="http://pycon.org/#calendar">Add an event</a> to this calendar.</p>
    </div>
  </div>

  <div id="content-body">
    <div id="body-main">
      <div id="content">
        
          <div id="breadcrumb">
               <a href="/dev/peps/">PEP Index</a>
               <span class="breadcrumb-separator">&gt;</span>
            
            PEP 346 -- User Defined ("with") Statements
          </div>



        <!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">346</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">User Defined (&quot;<tt class="docutils literal">with</tt>&quot;) Statements</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">e2b5d1a8a663</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="http://hg.python.org/peps/file/tip/pep-0346.txt">2009-01-18 09:50:42 +0000 (Sun, 18 Jan 2009)</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Nick Coghlan &lt;ncoghlan&#32;&#97;t&#32;gmail.com&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Withdrawn</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">6-May-2005</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">2.5</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id17">Abstract</a></li>
<li><a class="reference internal" href="#author-s-note" id="id18">Author's Note</a></li>
<li><a class="reference internal" href="#introduction" id="id19">Introduction</a></li>
<li><a class="reference internal" href="#relationship-with-other-peps" id="id20">Relationship with other PEPs</a></li>
<li><a class="reference internal" href="#user-defined-statements" id="id21">User defined statements</a><ul>
<li><a class="reference internal" href="#usage-syntax-for-user-defined-statements" id="id22">Usage syntax for user defined statements</a></li>
<li><a class="reference internal" href="#semantics-for-user-defined-statements" id="id23">Semantics for user defined statements</a></li>
<li><a class="reference internal" href="#statement-template-protocol-enter" id="id24">Statement template protocol: <tt class="docutils literal">__enter__</tt></a></li>
<li><a class="reference internal" href="#statement-template-protocol-exit" id="id25">Statement template protocol: <tt class="docutils literal">__exit__</tt></a></li>
<li><a class="reference internal" href="#factoring-out-arbitrary-exception-handling" id="id26">Factoring out arbitrary exception handling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#generators" id="id27">Generators</a><ul>
<li><a class="reference internal" href="#default-value-for-yield" id="id28">Default value for <tt class="docutils literal">yield</tt></a></li>
<li><a class="reference internal" href="#template-generator-decorator-statement-template" id="id29">Template generator decorator: <tt class="docutils literal">statement_template</tt></a></li>
<li><a class="reference internal" href="#template-generator-wrapper-enter-method" id="id30">Template generator wrapper: <tt class="docutils literal">__enter__()</tt> method</a></li>
<li><a class="reference internal" href="#template-generator-wrapper-exit-method" id="id31">Template generator wrapper: <tt class="docutils literal">__exit__()</tt> method</a></li>
<li><a class="reference internal" href="#injecting-exceptions-into-generators" id="id32">Injecting exceptions into generators</a></li>
<li><a class="reference internal" href="#generator-finalisation" id="id33">Generator finalisation</a></li>
<li><a class="reference internal" href="#generator-finalisation-terminateiteration-exception" id="id34">Generator finalisation: <tt class="docutils literal">TerminateIteration</tt> exception</a></li>
<li><a class="reference internal" href="#generator-finalisation-del-method" id="id35">Generator finalisation: <tt class="docutils literal">__del__()</tt> method</a></li>
<li><a class="reference internal" href="#deterministic-generator-finalisation" id="id36">Deterministic generator finalisation</a></li>
<li><a class="reference internal" href="#generators-as-user-defined-statement-templates" id="id37">Generators as user defined statement templates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples" id="id38">Examples</a></li>
<li><a class="reference internal" href="#open-issues" id="id39">Open Issues</a></li>
<li><a class="reference internal" href="#rejected-options" id="id40">Rejected Options</a><ul>
<li><a class="reference internal" href="#having-the-basic-construct-be-a-looping-construct" id="id41">Having the basic construct be a looping construct</a></li>
<li><a class="reference internal" href="#allowing-statement-templates-to-suppress-exceptions" id="id42">Allowing statement templates to suppress exceptions</a></li>
<li><a class="reference internal" href="#differentiating-between-non-exceptional-exits" id="id43">Differentiating between non-exceptional exits</a></li>
<li><a class="reference internal" href="#not-injecting-raised-exceptions-into-generators" id="id44">Not injecting raised exceptions into generators</a></li>
<li><a class="reference internal" href="#making-all-generators-statement-templates" id="id45">Making all generators statement templates</a></li>
<li><a class="reference internal" href="#using-do-as-the-keyword" id="id46">Using <tt class="docutils literal">do</tt> as the keyword</a></li>
<li><a class="reference internal" href="#not-having-a-keyword" id="id47">Not having a keyword</a></li>
<li><a class="reference internal" href="#enhancing-try-statements" id="id48">Enhancing <tt class="docutils literal">try</tt> statements</a></li>
<li><a class="reference internal" href="#having-the-template-protocol-directly-reflect-try-statements" id="id49">Having the template protocol directly reflect <tt class="docutils literal">try</tt> statements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iterator-finalisation-withdrawn" id="id50">Iterator finalisation (WITHDRAWN)</a><ul>
<li><a class="reference internal" href="#iterator-protocol-addition-finish" id="id51">Iterator protocol addition: <tt class="docutils literal">__finish__</tt></a></li>
<li><a class="reference internal" href="#best-effort-finalisation" id="id52">Best effort finalisation</a></li>
<li><a class="reference internal" href="#deterministic-finalisation" id="id53">Deterministic finalisation</a></li>
<li><a class="reference internal" href="#for-loop-syntax" id="id54"><tt class="docutils literal">for</tt> loop syntax</a></li>
<li><a class="reference internal" href="#updated-for-loop-semantics" id="id55">Updated <tt class="docutils literal">for</tt> loop semantics</a></li>
<li><a class="reference internal" href="#generator-iterator-finalisation-finish-method" id="id56">Generator iterator finalisation: <tt class="docutils literal">__finish__()</tt> method</a></li>
<li><a class="reference internal" href="#partial-iteration-of-finishable-iterators" id="id57">Partial iteration of finishable iterators</a></li>
</ul>
</li>
<li><a class="reference internal" href="#acknowledgements" id="id58">Acknowledgements</a></li>
<li><a class="reference internal" href="#references" id="id59">References</a></li>
<li><a class="reference internal" href="#copyright" id="id60">Copyright</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id17">Abstract</a></h1>
<p>This PEP is a combination of <a class="reference external" href="/dev/peps/pep-0310">PEP 310</a>'s &quot;Reliable Acquisition/Release
Pairs&quot; with the &quot;Anonymous Block Statements&quot; of Guido's <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>.  This
PEP aims to take the good parts of <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>, blend them with parts of
<a class="reference external" href="/dev/peps/pep-0310">PEP 310</a> and rearrange the lot into an elegant whole.  It borrows from
various other PEPs in order to paint a complete picture, and is
intended to stand on its own.</p>
</div>
<div class="section" id="author-s-note">
<h1><a class="toc-backref" href="#id18">Author's Note</a></h1>
<p>During the discussion of <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>, I maintained drafts of this PEP as
PEP 3XX on my own website (since I didn't have CVS access to update a
submitted PEP fast enough to track the activity on python-dev).</p>
<p>Since the first draft of this PEP, Guido wrote <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a> as a simplified
version of <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>.  <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a> (at the time of writing) uses the exact
same semantics for the new statements as this PEP, but uses a slightly
different mechanism to allow generators to be used to write statement
templates.  However, Guido has indicated that he intends to accept a
new PEP being written by Raymond Hettinger that will integrate <a class="reference external" href="/dev/peps/pep-0288">PEP 288</a>
and <a class="reference external" href="/dev/peps/pep-0325">PEP 325</a>, and will permit a generator decorator like the one
described in this PEP to be used to write statement templates for <a class="reference external" href="/dev/peps/pep-0343">PEP
343</a>. The other difference was the choice of keyword ('with' versus
'do') and Guido has stated he will organise a vote on that in the
context of <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a>.</p>
<p>Accordingly, the version of this PEP submitted for archiving on
python.org is to be WITHDRAWN immediately after submission.  <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a>
and the combined generator enhancement PEP will cover the important
ideas.</p>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#id19">Introduction</a></h1>
<p>This PEP proposes that Python's ability to reliably manage resources
be enhanced by the introduction of a new <tt class="docutils literal">with</tt> statement that
allows factoring out of arbitrary <tt class="docutils literal">try</tt>/<tt class="docutils literal">finally</tt> and some
<tt class="docutils literal">try</tt>/<tt class="docutils literal">except</tt>/<tt class="docutils literal">else</tt> boilerplate.  The new construct is called
a 'user defined statement', and the associated class definitions are
called 'statement templates'.</p>
<p>The above is the main point of the PEP.  However, if that was all it
said, then <a class="reference external" href="/dev/peps/pep-0310">PEP 310</a> would be sufficient and this PEP would be
essentially redundant. Instead, this PEP recommends additional
enhancements that make it natural to write these statement templates
using appropriately decorated generators.  A side effect of those
enhancements is that it becomes important to appropriately deal
with the management of resources inside generators.</p>
<p>This is quite similar to <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a>, but the exceptions that occur are
re-raised inside the generators frame, and the issue of generator
finalisation needs to be addressed as a result.  The template
generator decorator suggested by this PEP also creates reusable
templates, rather than the single use templates of <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>.</p>
<p>In comparison to <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>, this PEP eliminates the ability to suppress
exceptions, and makes the user defined statement a non-looping
construct.  The other main difference is the use of a decorator to
turn generators into statement templates, and the incorporation of
ideas for addressing iterator finalisation.</p>
<p>If all that seems like an ambitious operation. . . well, Guido was the
one to set the bar that high when he wrote <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a> :)</p>
</div>
<div class="section" id="relationship-with-other-peps">
<h1><a class="toc-backref" href="#id20">Relationship with other PEPs</a></h1>
<p>This PEP competes directly with <a class="reference external" href="/dev/peps/pep-0310">PEP 310</a> <a class="footnote-reference" href="#id9" id="id1">[1]</a>, <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a> <a class="footnote-reference" href="#id10" id="id2">[2]</a> and <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a>
<a class="footnote-reference" href="#id11" id="id3">[3]</a>, as those PEPs all describe alternative mechanisms for handling
deterministic resource management.</p>
<p>It does not compete with <a class="reference external" href="/dev/peps/pep-0342">PEP 342</a> <a class="footnote-reference" href="#id12" id="id4">[4]</a> which splits off <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>'s
enhancements related to passing data into iterators.  The associated
changes to the <tt class="docutils literal">for</tt> loop semantics would be combined with the
iterator finalisation changes suggested in this PEP.  User defined
statements would not be affected.</p>
<p>Neither does this PEP compete with the generator enhancements
described in <a class="reference external" href="/dev/peps/pep-0288">PEP 288</a> <a class="footnote-reference" href="#id13" id="id5">[5]</a>.  While this PEP proposes the ability to
inject exceptions into generator frames, it is an internal
implementation detail, and does not require making that ability
publicly available to Python code.  <a class="reference external" href="/dev/peps/pep-0288">PEP 288</a> is, in part, about
making that implementation detail easily accessible.</p>
<p>This PEP would, however, make the generator resource release support
described in <a class="reference external" href="/dev/peps/pep-0325">PEP 325</a> <a class="footnote-reference" href="#id14" id="id6">[6]</a> redundant - iterators which require
finalisation should provide an appropriate implementation of the
statement template protocol.</p>
</div>
<div class="section" id="user-defined-statements">
<h1><a class="toc-backref" href="#id21">User defined statements</a></h1>
<p>To steal the motivating example from <a class="reference external" href="/dev/peps/pep-0310">PEP 310</a>, correct handling of a
synchronisation lock currently looks like this:</p>
<pre class="literal-block">
the_lock.acquire()
try:
    # Code here executes with the lock held
finally:
    the_lock.release()
</pre>
<p>Like <a class="reference external" href="/dev/peps/pep-0310">PEP 310</a>, this PEP proposes that such code be able to be written
as:</p>
<pre class="literal-block">
with the_lock:
    # Code here executes with the lock held
</pre>
<p>These user defined statements are primarily designed to allow easy
factoring of <tt class="docutils literal">try</tt> blocks that are not easily converted to
functions.  This is most commonly the case when the exception handling
pattern is consistent, but the body of the <tt class="docutils literal">try</tt> block changes.
With a user-defined statement, it is straightforward to factor out the
exception handling into a statement template, with the body of the
<tt class="docutils literal">try</tt> clause provided inline in the user code.</p>
<p>The term 'user defined statement' reflects the fact that the meaning
of a <tt class="docutils literal">with</tt> statement is governed primarily by the statement
template used, and programmers are free to create their own statement
templates, just as they are free to create their own iterators for use
in <tt class="docutils literal">for</tt> loops.</p>
<div class="section" id="usage-syntax-for-user-defined-statements">
<h2><a class="toc-backref" href="#id22">Usage syntax for user defined statements</a></h2>
<p>The proposed syntax is simple:</p>
<pre class="literal-block">
with EXPR1 [as VAR1]:
    BLOCK1
</pre>
</div>
<div class="section" id="semantics-for-user-defined-statements">
<h2><a class="toc-backref" href="#id23">Semantics for user defined statements</a></h2>
<pre class="literal-block">
the_stmt = EXPR1
stmt_enter = getattr(the_stmt, &quot;__enter__&quot;, None)
stmt_exit = getattr(the_stmt, &quot;__exit__&quot;, None)
if stmt_enter is None or stmt_exit is None:
    raise TypeError(&quot;Statement template required&quot;)

VAR1 = stmt_enter() # Omit 'VAR1 =' if no 'as' clause
exc = (None, None, None)
try:
    try:
        BLOCK1
    except:
        exc = sys.exc_info()
        raise
finally:
    stmt_exit(*exc)
</pre>
<p>Other than <tt class="docutils literal">VAR1</tt>, none of the local variables shown above will be
visible to user code.  Like the iteration variable in a <tt class="docutils literal">for</tt> loop,
<tt class="docutils literal">VAR1</tt> is visible in both <tt class="docutils literal">BLOCK1</tt> and code following the user
defined statement.</p>
<p>Note that the statement template can only react to exceptions, it
cannot suppress them.  See <a class="reference internal" href="#rejected-options">Rejected Options</a> for an explanation as
to why.</p>
</div>
<div class="section" id="statement-template-protocol-enter">
<h2><a class="toc-backref" href="#id24">Statement template protocol: <tt class="docutils literal">__enter__</tt></a></h2>
<p>The <tt class="docutils literal">__enter__()</tt> method takes no arguments, and if it raises an
exception, <tt class="docutils literal">BLOCK1</tt> is never executed.  If this happens, the
<tt class="docutils literal">__exit__()</tt> method is not called.  The value returned by this
method is assigned to VAR1 if the <tt class="docutils literal">as</tt> clause is used.  Object's
with no other value to return should generally return <tt class="docutils literal">self</tt> rather
than <tt class="docutils literal">None</tt> to permit in-place creation in the <tt class="docutils literal">with</tt> statement.</p>
<p>Statement templates should use this method to set up the conditions
that are to exist during execution of the statement (e.g. acquisition
of a synchronisation lock).</p>
<p>Statement templates which are not always usable (e.g. closed file
objects) should raise a <tt class="docutils literal">RuntimeError</tt> if an attempt is made to call
<tt class="docutils literal">__enter__()</tt> when the template is not in a valid state.</p>
</div>
<div class="section" id="statement-template-protocol-exit">
<h2><a class="toc-backref" href="#id25">Statement template protocol: <tt class="docutils literal">__exit__</tt></a></h2>
<p>The <tt class="docutils literal">__exit__()</tt> method accepts three arguments which correspond to
the three &quot;arguments&quot; to the <tt class="docutils literal">raise</tt> statement: type, value, and
traceback.  All arguments are always supplied, and will be set to
<tt class="docutils literal">None</tt> if no exception occurred.  This method will be called exactly
once by the <tt class="docutils literal">with</tt> statement machinery if the <tt class="docutils literal">__enter__()</tt> method
completes successfully.</p>
<p>Statement templates perform their exception handling in this method.
If the first argument is <tt class="docutils literal">None</tt>, it indicates non-exceptional
completion of <tt class="docutils literal">BLOCK1</tt> - execution either reached the end of block,
or early completion was forced using a <tt class="docutils literal">return</tt>, <tt class="docutils literal">break</tt> or
<tt class="docutils literal">continue</tt> statement.  Otherwise, the three arguments reflect the
exception that terminated <tt class="docutils literal">BLOCK1</tt>.</p>
<p>Any exceptions raised by the <tt class="docutils literal">__exit__()</tt> method are propagated to
the scope containing the <tt class="docutils literal">with</tt> statement.  If the user code in
<tt class="docutils literal">BLOCK1</tt> also raised an exception, that exception would be lost, and
replaced by the one raised by the <tt class="docutils literal">__exit__()</tt> method.</p>
</div>
<div class="section" id="factoring-out-arbitrary-exception-handling">
<h2><a class="toc-backref" href="#id26">Factoring out arbitrary exception handling</a></h2>
<p>Consider the following exception handling arrangement:</p>
<pre class="literal-block">
SETUP_BLOCK
try:
    try:
        TRY_BLOCK
    except exc_type1, exc:
        EXCEPT_BLOCK1
    except exc_type2, exc:
        EXCEPT_BLOCK2
    except:
        EXCEPT_BLOCK3
    else:
        ELSE_BLOCK
finally:
    FINALLY_BLOCK
</pre>
<p>It can be roughly translated to a statement template as follows:</p>
<pre class="literal-block">
class my_template(object):

    def __init__(self, *args):
        # Any required arguments (e.g. a file name)
        # get stored in member variables
        # The various BLOCK's will need updating to reflect
        # that.

    def __enter__(self):
        SETUP_BLOCK

    def __exit__(self, exc_type, value, traceback):
        try:
            try:
                if exc_type is not None:
                    raise exc_type, value, traceback
            except exc_type1, exc:
                EXCEPT_BLOCK1
            except exc_type2, exc:
                EXCEPT_BLOCK2
            except:
                EXCEPT_BLOCK3
            else:
                ELSE_BLOCK
        finally:
            FINALLY_BLOCK
</pre>
<p>Which can then be used as:</p>
<pre class="literal-block">
with my_template(*args):
    TRY_BLOCK
</pre>
<p>However, there are two important semantic differences between this
code and the original <tt class="docutils literal">try</tt> statement.</p>
<p>Firstly, in the original <tt class="docutils literal">try</tt> statement, if a <tt class="docutils literal">break</tt>, <tt class="docutils literal">return</tt>
or <tt class="docutils literal">continue</tt> statement is encountered in <tt class="docutils literal">TRY_BLOCK</tt>, only
<tt class="docutils literal">FINALLY_BLOCK</tt> will be executed as the statement completes.  With
the statement template, <tt class="docutils literal">ELSE_BLOCK</tt> will also execute, as these
statements are treated like any other non-exceptional block
termination.  For use cases where it matters, this is likely to be a
good thing (see <tt class="docutils literal">transaction</tt> in the <a class="reference internal" href="#examples">Examples</a>), as this hole where
neither the <tt class="docutils literal">except</tt> nor the <tt class="docutils literal">else</tt> clause gets executed is easy
to forget when writing exception handlers.</p>
<p>Secondly, the statement template will not suppress any exceptions.
If, for example, the original code suppressed the <tt class="docutils literal">exc_type1</tt> and
<tt class="docutils literal">exc_type2</tt> exceptions, then this would still need to be done inline
in the user code:</p>
<pre class="literal-block">
try:
    with my_template(*args):
        TRY_BLOCK
except (exc_type1, exc_type2):
    pass
</pre>
<p>However, even in these cases where the suppression of exceptions needs
to be made explicit, the amount of boilerplate repeated at the calling
site is significantly reduced (See <a class="reference internal" href="#rejected-options">Rejected Options</a> for further
discussion of this behaviour).</p>
<p>In general, not all of the clauses will be needed.  For resource
handling (like files or synchronisation locks), it is possible to
simply execute the code that would have been part of <tt class="docutils literal">FINALLY_BLOCK</tt>
in the <tt class="docutils literal">__exit__()</tt> method.  This can be seen in the following
implementation that makes synchronisation locks into statement
templates as mentioned at the beginning of this section:</p>
<pre class="literal-block">
# New methods of synchronisation lock objects

def __enter__(self):
    self.acquire()
    return self

def __exit__(self, *exc_info):
    self.release()
</pre>
</div>
</div>
<div class="section" id="generators">
<h1><a class="toc-backref" href="#id27">Generators</a></h1>
<p>With their ability to suspend execution, and return control to the
calling frame, generators are natural candidates for writing statement
templates.  Adding user defined statements to the language does <em>not</em>
require the generator changes described in this section, thus making
this PEP an obvious candidate for a phased implementation (<tt class="docutils literal">with</tt>
statements in phase 1, generator integration in phase 2).  The
suggested generator updates allow arbitrary exception handling to
be factored out like this:</p>
<pre class="literal-block">
&#64;statement_template
def my_template(*arguments):
    SETUP_BLOCK
    try:
        try:
            yield
        except exc_type1, exc:
            EXCEPT_BLOCK1
        except exc_type2, exc:
            EXCEPT_BLOCK2
        except:
            EXCEPT_BLOCK3
        else:
            ELSE_BLOCK
    finally:
        FINALLY_BLOCK
</pre>
<p>Notice that, unlike the class based version, none of the blocks need
to be modified, as shared values are local variables of the
generator's internal frame, including the arguments passed in by the
invoking code.  The semantic differences noted earlier (all
non-exceptional block termination triggers the <tt class="docutils literal">else</tt> clause, and
the template is unable to suppress exceptions) still apply.</p>
<div class="section" id="default-value-for-yield">
<h2><a class="toc-backref" href="#id28">Default value for <tt class="docutils literal">yield</tt></a></h2>
<p>When creating a statement template with a generator, the <tt class="docutils literal">yield</tt>
statement will often be used solely to return control to the body of
the user defined statement, rather than to return a useful value.</p>
<p>Accordingly, if this PEP is accepted, <tt class="docutils literal">yield</tt>, like <tt class="docutils literal">return</tt>, will
supply a default value of <tt class="docutils literal">None</tt> (i.e. <tt class="docutils literal">yield</tt> and <tt class="docutils literal">yield None</tt>
will become equivalent statements).</p>
<p>This same change is being suggested in <a class="reference external" href="/dev/peps/pep-0342">PEP 342</a>.  Obviously, it would
only need to be implemented once if both PEPs were accepted :)</p>
</div>
<div class="section" id="template-generator-decorator-statement-template">
<h2><a class="toc-backref" href="#id29">Template generator decorator: <tt class="docutils literal">statement_template</tt></a></h2>
<p>As with <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a>, a new decorator is suggested that wraps a generator
in an object with the appropriate statement template semantics.
Unlike <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a>, the templates suggested here are reusable, as the
generator is instantiated anew in each call to <tt class="docutils literal">__enter__()</tt>.
Additionally, any exceptions that occur in <tt class="docutils literal">BLOCK1</tt> are re-raised in
the generator's internal frame:</p>
<pre class="literal-block">
class template_generator_wrapper(object):

    def __init__(self, func, func_args, func_kwds):
         self.func = func
         self.args = func_args
         self.kwds = func_kwds
         self.gen = None

    def __enter__(self):
        if self.gen is not None:
            raise RuntimeError(&quot;Enter called without exit!&quot;)
        self.gen = self.func(*self.args, **self.kwds)
        try:
            return self.gen.next()
        except StopIteration:
            raise RuntimeError(&quot;Generator didn't yield&quot;)

    def __exit__(self, *exc_info):
        if self.gen is None:
            raise RuntimeError(&quot;Exit called without enter!&quot;)
        try:
            try:
                if exc_info[0] is not None:
                    self.gen._inject_exception(*exc_info)
                else:
                    self.gen.next()
            except StopIteration:
                pass
            else:
                raise RuntimeError(&quot;Generator didn't stop&quot;)
        finally:
            self.gen = None

def statement_template(func):
    def factory(*args, **kwds):
        return template_generator_wrapper(func, args, kwds)
    return factory
</pre>
</div>
<div class="section" id="template-generator-wrapper-enter-method">
<h2><a class="toc-backref" href="#id30">Template generator wrapper: <tt class="docutils literal">__enter__()</tt> method</a></h2>
<p>The template generator wrapper has an <tt class="docutils literal">__enter__()</tt> method that
creates a new instance of the contained generator, and then invokes
<tt class="docutils literal">next()</tt> once.  It will raise a <tt class="docutils literal">RuntimeError</tt> if the last
generator instance has not been cleaned up, or if the generator
terminates instead of yielding a value.</p>
</div>
<div class="section" id="template-generator-wrapper-exit-method">
<h2><a class="toc-backref" href="#id31">Template generator wrapper: <tt class="docutils literal">__exit__()</tt> method</a></h2>
<p>The template generator wrapper has an <tt class="docutils literal">__exit__()</tt> method that
simply invokes <tt class="docutils literal">next()</tt> on the generator if no exception is passed
in.  If an exception is passed in, it is re-raised in the contained
generator at the point of the last <tt class="docutils literal">yield</tt> statement.</p>
<p>In either case, the generator wrapper will raise a RuntimeError if the
internal frame does not terminate as a result of the operation.  The
<tt class="docutils literal">__exit__()</tt> method will always clean up the reference to the used
generator instance, permitting <tt class="docutils literal">__enter__()</tt> to be called again.</p>
<p>A <tt class="docutils literal">StopIteration</tt> raised by the body of the user defined statement
may be inadvertently suppressed inside the <tt class="docutils literal">__exit__()</tt> method, but
this is unimportant, as the originally raised exception still
propagates correctly.</p>
</div>
<div class="section" id="injecting-exceptions-into-generators">
<h2><a class="toc-backref" href="#id32">Injecting exceptions into generators</a></h2>
<p>To implement the <tt class="docutils literal">__exit__()</tt> method of the template generator
wrapper, it is necessary to inject exceptions into the internal frame
of the generator.  This is new implementation level behaviour that has
no current Python equivalent.</p>
<p>The injection mechanism (referred to as <tt class="docutils literal">_inject_exception</tt> in this
PEP) raises an exception in the generator's frame with the specified
type, value and traceback information.  This means that the exception
looks like the original if it is allowed to propagate.</p>
<p>For the purposes of this PEP, there is no need to make this capability
available outside the Python implementation code.</p>
</div>
<div class="section" id="generator-finalisation">
<h2><a class="toc-backref" href="#id33">Generator finalisation</a></h2>
<p>To support resource management in template generators, this PEP will
eliminate the restriction on <tt class="docutils literal">yield</tt> statements inside the <tt class="docutils literal">try</tt>
block of a <tt class="docutils literal">try</tt>/<tt class="docutils literal">finally</tt> statement.  Accordingly, generators
which require the use of a file or some such object can ensure the
object is managed correctly through the use of <tt class="docutils literal">try</tt>/<tt class="docutils literal">finally</tt> or
<tt class="docutils literal">with</tt> statements.</p>
<p>This restriction will likely need to be lifted globally - it would be
difficult to restrict it so that it was only permitted inside
generators used to define statement templates.  Accordingly, this PEP
includes suggestions designed to ensure generators which are not used
as statement templates are still finalised appropriately.</p>
</div>
<div class="section" id="generator-finalisation-terminateiteration-exception">
<h2><a class="toc-backref" href="#id34">Generator finalisation: <tt class="docutils literal">TerminateIteration</tt> exception</a></h2>
<p>A new exception is proposed:</p>
<pre class="literal-block">
class TerminateIteration(Exception): pass
</pre>
<p>The new exception is injected into a generator in order to request
finalisation.  It should not be suppressed by well-behaved code.</p>
</div>
<div class="section" id="generator-finalisation-del-method">
<h2><a class="toc-backref" href="#id35">Generator finalisation: <tt class="docutils literal">__del__()</tt> method</a></h2>
<p>To ensure a generator is finalised eventually (within the limits of
Python's garbage collection), generators will acquire a <tt class="docutils literal">__del__()</tt>
method with the following semantics:</p>
<pre class="literal-block">
def __del__(self):
    try:
        self._inject_exception(TerminateIteration, None, None)
    except TerminateIteration:
        pass
</pre>
</div>
<div class="section" id="deterministic-generator-finalisation">
<h2><a class="toc-backref" href="#id36">Deterministic generator finalisation</a></h2>
<p>There is a simple way to provide deterministic finalisation of
generators - give them appropriate <tt class="docutils literal">__enter__()</tt> and <tt class="docutils literal">__exit__()</tt>
methods:</p>
<pre class="literal-block">
def __enter__(self):
    return self

def __exit__(self, *exc_info):
    try:
        self._inject_exception(TerminateIteration, None, None)
    except TerminateIteration:
        pass
</pre>
<p>Then any generator can be finalised promptly by wrapping the relevant
<tt class="docutils literal">for</tt> loop inside a <tt class="docutils literal">with</tt> statement:</p>
<pre class="literal-block">
with all_lines(filenames) as lines:
    for line in lines:
        print lines
</pre>
<p>(See the <a class="reference internal" href="#examples">Examples</a> for the definition of <tt class="docutils literal">all_lines</tt>, and the reason
it requires prompt finalisation)</p>
<p>Compare the above example to the usage of file objects:</p>
<pre class="literal-block">
with open(filename) as f:
    for line in f:
        print f
</pre>
</div>
<div class="section" id="generators-as-user-defined-statement-templates">
<h2><a class="toc-backref" href="#id37">Generators as user defined statement templates</a></h2>
<p>When used to implement a user defined statement, a generator should
yield only once on a given control path.  The result of that yield
will then be provided as the result of the generator's <tt class="docutils literal">__enter__()</tt>
method.  Having a single <tt class="docutils literal">yield</tt> on each control path ensures that
the internal frame will terminate when the generator's <tt class="docutils literal">__exit__()</tt>
method is called.  Multiple <tt class="docutils literal">yield</tt> statements on a single control
path will result in a <tt class="docutils literal">RuntimeError</tt> being raised by the
<tt class="docutils literal">__exit__()</tt> method when the internal frame fails to terminate
correctly.  Such an error indicates a bug in the statement template.</p>
<p>To respond to exceptions, or to clean up resources, it is sufficient
to wrap the <tt class="docutils literal">yield</tt> statement in an appropriately constructed
<tt class="docutils literal">try</tt> statement.  If execution resumes after the <tt class="docutils literal">yield</tt> without
an exception, the generator knows that the body of the <tt class="docutils literal">do</tt>
statement completed without incident.</p>
</div>
</div>
<div class="section" id="examples">
<h1><a class="toc-backref" href="#id38">Examples</a></h1>
<ol class="arabic">
<li><p class="first">A template for ensuring that a lock, acquired at the start of a
block, is released when the block is left:</p>
<pre class="literal-block">
# New methods on synchronisation locks
    def __enter__(self):
        self.acquire()
        return self

    def __exit__(self, *exc_info):
        lock.release()
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
with myLock:
    # Code here executes with myLock held.  The lock is
    # guaranteed to be released when the block is left (even
    # if via return or by an uncaught exception).
</pre>
</li>
<li><p class="first">A template for opening a file that ensures the file is closed when
the block is left:</p>
<pre class="literal-block">
# New methods on file objects
    def __enter__(self):
        if self.closed:
            raise RuntimeError, &quot;Cannot reopen closed file handle&quot;
        return self

    def __exit__(self, *args):
        self.close()
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
with open(&quot;/etc/passwd&quot;) as f:
    for line in f:
        print line.rstrip()
</pre>
</li>
<li><p class="first">A template for committing or rolling back a database transaction:</p>
<pre class="literal-block">
def transaction(db):
    try:
        yield
    except:
        db.rollback()
    else:
        db.commit()
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
with transaction(the_db):
    make_table(the_db)
    add_data(the_db)
    # Getting to here automatically triggers a commit
    # Any exception automatically triggers a rollback
</pre>
</li>
<li><p class="first">It is possible to nest blocks and combine templates:</p>
<pre class="literal-block">
&#64;statement_template
def lock_opening(lock, filename, mode=&quot;r&quot;):
    with lock:
        with open(filename, mode) as f:
            yield f
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
with lock_opening(myLock, &quot;/etc/passwd&quot;) as f:
    for line in f:
        print line.rstrip()
</pre>
</li>
<li><p class="first">Redirect stdout temporarily:</p>
<pre class="literal-block">
&#64;statement_template
def redirected_stdout(new_stdout):
    save_stdout = sys.stdout
    try:
        sys.stdout = new_stdout
        yield
    finally:
        sys.stdout = save_stdout
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
with open(filename, &quot;w&quot;) as f:
    with redirected_stdout(f):
        print &quot;Hello world&quot;
</pre>
</li>
<li><p class="first">A variant on <tt class="docutils literal">open()</tt> that also returns an error condition:</p>
<pre class="literal-block">
&#64;statement_template
def open_w_error(filename, mode=&quot;r&quot;):
    try:
        f = open(filename, mode)
    except IOError, err:
        yield None, err
    else:
        try:
            yield f, None
        finally:
            f.close()
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
do open_w_error(&quot;/etc/passwd&quot;, &quot;a&quot;) as f, err:
    if err:
        print &quot;IOError:&quot;, err
    else:
        f.write(&quot;guido::0:0::/:/bin/sh\n&quot;)
</pre>
</li>
<li><p class="first">Find the first file with a specific header:</p>
<pre class="literal-block">
for name in filenames:
    with open(name) as f:
        if f.read(2) == 0xFEB0:
            break
</pre>
</li>
<li><p class="first">Find the first item you can handle, holding a lock for the entire
loop, or just for each iteration:</p>
<pre class="literal-block">
with lock:
    for item in items:
        if handle(item):
            break

for item in items:
    with lock:
        if handle(item):
            break
</pre>
</li>
<li><p class="first">Hold a lock while inside a generator, but release it when
returning control to the outer scope:</p>
<pre class="literal-block">
&#64;statement_template
def released(lock):
    lock.release()
    try:
        yield
    finally:
        lock.acquire()
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
with lock:
    for item in items:
        with released(lock):
            yield item
</pre>
</li>
<li><p class="first">Read the lines from a collection of files (e.g. processing
multiple configuration sources):</p>
<pre class="literal-block">
def all_lines(filenames):
    for name in filenames:
        with open(name) as f:
            for line in f:
                yield line
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
with all_lines(filenames) as lines:
    for line in lines:
        update_config(line)
</pre>
</li>
<li><p class="first">Not all uses need to involve resource management:</p>
<pre class="literal-block">
&#64;statement_template
def tag(*args, **kwds):
    name = cgi.escape(args[0])
    if kwds:
        kwd_pairs = [&quot;%s=%s&quot; % cgi.escape(key), cgi.escape(value)
                     for key, value in kwds]
        print '&lt;%s %s&gt;' % name, &quot; &quot;.join(kwd_pairs)
    else:
        print '&lt;%s&gt;' % name
    yield
    print '&lt;/%s&gt;' % name
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
with tag('html'):
    with tag('head'):
       with tag('title'):
          print 'A web page'
    with tag('body'):
       for par in pars:
          with tag('p'):
             print par
       with tag('a', href=&quot;http://www.python.org&quot;):
           print &quot;Not a dead parrot!&quot;
</pre>
</li>
<li><p class="first">From <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a>, another useful example would be an operation that
blocks signals.  The use could be like this:</p>
<pre class="literal-block">
from signal import blocked_signals

with blocked_signals():
    # code executed without worrying about signals
</pre>
<p>An optional argument might be a list of signals to be blocked; by
default all signals are blocked.  The implementation is left as an
exercise to the reader.</p>
</li>
<li><p class="first">Another use for this feature is for Decimal contexts:</p>
<pre class="literal-block">
# New methods on decimal Context objects

def __enter__(self):
    if self._old_context is not None:
        raise RuntimeError(&quot;Already suspending other Context&quot;)
    self._old_context = getcontext()
    setcontext(self)

def __exit__(self, *args):
    setcontext(self._old_context)
    self._old_context = None
</pre>
<p>Used as follows:</p>
<pre class="literal-block">
with decimal.Context(precision=28):
   # Code here executes with the given context
   # The context always reverts after this statement
</pre>
</li>
</ol>
</div>
<div class="section" id="open-issues">
<h1><a class="toc-backref" href="#id39">Open Issues</a></h1>
<p>None, as this PEP has been withdrawn.</p>
</div>
<div class="section" id="rejected-options">
<h1><a class="toc-backref" href="#id40">Rejected Options</a></h1>
<div class="section" id="having-the-basic-construct-be-a-looping-construct">
<h2><a class="toc-backref" href="#id41">Having the basic construct be a looping construct</a></h2>
<p>The major issue with this idea, as illustrated by <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>'s
<tt class="docutils literal">block</tt> statements, is that it causes problems with factoring
<tt class="docutils literal">try</tt> statements that are inside loops, and contain <tt class="docutils literal">break</tt> and
<tt class="docutils literal">continue</tt> statements (as these statements would then apply to the
<tt class="docutils literal">block</tt> construct, instead of the original loop).  As a key goal is
to be able to factor out arbitrary exception handling (other than
suppression) into statement templates, this is a definite problem.</p>
<p>There is also an understandability problem, as can be seen in the
<a class="reference internal" href="#examples">Examples</a>.  In the example showing acquisition of a lock either for an
entire loop, or for each iteration of the loop, if the user defined
statement was itself a loop, moving it from outside the <tt class="docutils literal">for</tt> loop
to inside the <tt class="docutils literal">for</tt> loop would have major semantic implications,
beyond those one would expect.</p>
<p>Finally, with a looping construct, there are significant problems with
TOOWTDI, as it is frequently unclear whether a particular situation
should be handled with a conventional <tt class="docutils literal">for</tt> loop or the new looping
construct.  With the current PEP, there is no such problem - <tt class="docutils literal">for</tt>
loops continue to be used for iteration, and the new <tt class="docutils literal">do</tt> statements
are used to factor out exception handling.</p>
<p>Another issue, specifically with <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>'s anonymous block statements,
is that they make it quite difficult to write statement templates
directly (i.e. not using a generator).  This problem is addressed by
the current proposal, as can be seen by the relative simplicity of the
various class based implementations of statement templates in the
<a class="reference internal" href="#examples">Examples</a>.</p>
</div>
<div class="section" id="allowing-statement-templates-to-suppress-exceptions">
<h2><a class="toc-backref" href="#id42">Allowing statement templates to suppress exceptions</a></h2>
<p>Earlier versions of this PEP gave statement templates the ability to
suppress exceptions.  The BDFL expressed concern over the associated
complexity, and I agreed after reading an article by Raymond Chen
about the evils of hiding flow control inside macros in C code <a class="footnote-reference" href="#id15" id="id7">[7]</a>.</p>
<p>Removing the suppression ability eliminated a whole lot of complexity
from both the explanation and implementation of user defined
statements, further supporting it as the correct choice.  Older
versions of the PEP had to jump through some horrible hoops to avoid
inadvertently suppressing exceptions in <tt class="docutils literal">__exit__()</tt> methods - that
issue does not exist with the current suggested semantics.</p>
<p>There was one example (<tt class="docutils literal">auto_retry</tt>) that actually used the ability
to suppress exceptions.  This use case, while not quite as elegant,
has significantly more obvious control flow when written out in full
in the user code:</p>
<pre class="literal-block">
def attempts(num_tries):
    return reversed(xrange(num_tries))

for retry in attempts(3):
    try:
        make_attempt()
    except IOError:
        if not retry:
            raise
</pre>
<p>For what it's worth, the perverse could still write this as:</p>
<pre class="literal-block">
for attempt in auto_retry(3, IOError):
    try:
        with attempt:
            make_attempt()
    except FailedAttempt:
        pass
</pre>
<p>To protect the innocent, the code to actually support that is not
included here.</p>
</div>
<div class="section" id="differentiating-between-non-exceptional-exits">
<h2><a class="toc-backref" href="#id43">Differentiating between non-exceptional exits</a></h2>
<p>Earlier versions of this PEP allowed statement templates to
distinguish between exiting the block normally, and exiting via a
<tt class="docutils literal">return</tt>, <tt class="docutils literal">break</tt> or <tt class="docutils literal">continue</tt> statement.  The BDFL flirted
with a similar idea in <a class="reference external" href="/dev/peps/pep-0343">PEP 343</a> and its associated discussion.  This
added significant complexity to the description of the semantics, and
it required each and every statement template to decide whether or not
those statements should be treated like exceptions, or like a normal
mechanism for exiting the block.</p>
<p>This template-by-template decision process raised great potential for
confusion - consider if one database connector provided a transaction
template that treated early exits like an exception, whereas a second
connector treated them as normal block termination.</p>
<p>Accordingly, this PEP now uses the simplest solution - early exits
appear identical to normal block termination as far as the statement
template is concerned.</p>
</div>
<div class="section" id="not-injecting-raised-exceptions-into-generators">
<h2><a class="toc-backref" href="#id44">Not injecting raised exceptions into generators</a></h2>
<p><a class="reference external" href="/dev/peps/pep-0343">PEP 343</a> suggests simply invoking next() unconditionally on generators
used to define statement templates.  This means the template
generators end up looking rather unintuitive, and the retention of the
ban against yielding inside <tt class="docutils literal">try</tt>/<tt class="docutils literal">finally</tt> means that Python's
exception handling capabilities cannot be used to deal with management
of multiple resources.</p>
<p>The alternative which this PEP advocates (injecting raised exceptions
into the generator frame), means that multiple resources can be
managed elegantly as shown by <tt class="docutils literal">lock_opening</tt> in the <a class="reference internal" href="#examples">Examples</a></p>
</div>
<div class="section" id="making-all-generators-statement-templates">
<h2><a class="toc-backref" href="#id45">Making all generators statement templates</a></h2>
<p>Separating the template object from the generator itself makes it
possible to have reusable generator templates.  That is, the following
code will work correctly if this PEP is accepted:</p>
<pre class="literal-block">
open_it = lock_opening(parrot_lock, &quot;dead_parrot.txt&quot;)

with open_it as f:
    # use the file for a while

with open_it as f:
    # use the file again
</pre>
<p>The second benefit is that iterator generators and template generators
are very different things - the decorator keeps that distinction
clear, and prevents one being used where the other is required.</p>
<p>Finally, requiring the decorator allows the native methods of
generator objects to be used to implement generator finalisation.</p>
</div>
<div class="section" id="using-do-as-the-keyword">
<h2><a class="toc-backref" href="#id46">Using <tt class="docutils literal">do</tt> as the keyword</a></h2>
<p><tt class="docutils literal">do</tt> was an alternative keyword proposed during the <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a>
discussion.  It reads well with appropriately named functions, but it
reads poorly when used with methods, or with objects that provide
native statement template support.</p>
<p>When <tt class="docutils literal">do</tt> was first suggested, the BDFL had rejected <a class="reference external" href="/dev/peps/pep-0310">PEP 310</a>'s
<tt class="docutils literal">with</tt> keyword, based on a desire to use it for a Pascal/Delphi
style <tt class="docutils literal">with</tt> statement.  Since then, the BDFL has retracted this
objection, as he no longer intends to provide such a statement.  This
change of heart was apparently based on the C# developers reasons for
not providing the feature <a class="footnote-reference" href="#id16" id="id8">[8]</a>.</p>
</div>
<div class="section" id="not-having-a-keyword">
<h2><a class="toc-backref" href="#id47">Not having a keyword</a></h2>
<p>This is an interesting option, and can be made to read quite well.
However, it's awkward to look up in the documentation for new users,
and strikes some as being too magical.  Accordingly, this PEP goes
with a keyword based suggestion.</p>
</div>
<div class="section" id="enhancing-try-statements">
<h2><a class="toc-backref" href="#id48">Enhancing <tt class="docutils literal">try</tt> statements</a></h2>
<p>This suggestion involves give bare <tt class="docutils literal">try</tt> statements a signature
similar to that proposed for <tt class="docutils literal">with</tt> statements.</p>
<p>I think that trying to write a <tt class="docutils literal">with</tt> statement as an enhanced
<tt class="docutils literal">try</tt> statement makes as much sense as trying to write a <tt class="docutils literal">for</tt>
loop as an enhanced <tt class="docutils literal">while</tt> loop.  That is, while the semantics of
the former can be explained as a particular way of using the latter,
the former is not an <em>instance</em> of the latter.  The additional
semantics added around the more fundamental statement result in a new
construct, and the two different statements shouldn't be confused.</p>
<p>This can be seen by the fact that the 'enhanced' <tt class="docutils literal">try</tt> statement
still needs to be explained in terms of a 'non-enhanced' <tt class="docutils literal">try</tt>
statement.  If it's something different, it makes more sense to give
it a different name.</p>
</div>
<div class="section" id="having-the-template-protocol-directly-reflect-try-statements">
<h2><a class="toc-backref" href="#id49">Having the template protocol directly reflect <tt class="docutils literal">try</tt> statements</a></h2>
<p>One suggestion was to have separate methods in the protocol to cover
different parts of the structure of a generalised <tt class="docutils literal">try</tt> statement.
Using the terms <tt class="docutils literal">try</tt>, <tt class="docutils literal">except</tt>, <tt class="docutils literal">else</tt> and <tt class="docutils literal">finally</tt>, we
would have something like:</p>
<pre class="literal-block">
class my_template(object):

    def __init__(self, *args):
        # Any required arguments (e.g. a file name)
        # get stored in member variables
        # The various BLOCK's will need to updated to reflect
        # that.

    def __try__(self):
        SETUP_BLOCK

    def __except__(self, exc, value, traceback):
        if isinstance(exc, exc_type1):
            EXCEPT_BLOCK1
        if isinstance(exc, exc_type2):
            EXCEPT_BLOCK2
        else:
            EXCEPT_BLOCK3

    def __else__(self):
        ELSE_BLOCK

    def __finally__(self):
        FINALLY_BLOCK
</pre>
<p>Aside from preferring the addition of two method slots rather than
four, I consider it significantly easier to be able to simply
reproduce a slightly modified version of the original <tt class="docutils literal">try</tt>
statement code in the <tt class="docutils literal">__exit__()</tt> method (as shown in <a class="reference internal" href="#factoring-out-arbitrary-exception-handling">Factoring
out arbitrary exception handling</a>), rather than have to split the
functionality amongst several different methods (or figure out
which method to use if not all clauses are used by the template).</p>
<p>To make this discussion less theoretical, here is the <tt class="docutils literal">transaction</tt>
example implemented using both the two method and the four method
protocols instead of a generator.  Both implementations guarantee a
commit if a <tt class="docutils literal">break</tt>, <tt class="docutils literal">return</tt> or <tt class="docutils literal">continue</tt> statement is
encountered (as does the generator-based implementation in the
<a class="reference internal" href="#examples">Examples</a> section):</p>
<pre class="literal-block">
class transaction_2method(object):

    def __init__(self, db):
        self.db = db

    def __enter__(self):
        pass

    def __exit__(self, exc_type, *exc_details):
        if exc_type is None:
            self.db.commit()
        else:
            self.db.rollback()

class transaction_4method(object):

    def __init__(self, db):
        self.db = db
        self.commit = False

    def __try__(self):
        self.commit = True

    def __except__(self, exc_type, exc_value, traceback):
        self.db.rollback()
        self.commit = False

    def __else__(self):
        pass

    def __finally__(self):
        if self.commit:
            self.db.commit()
            self.commit = False
</pre>
<p>There are two more minor points, relating to the specific method names
in the suggestion.  The name of the <tt class="docutils literal">__try__()</tt> method is
misleading, as <tt class="docutils literal">SETUP_BLOCK</tt> executes <em>before</em> the <tt class="docutils literal">try</tt> statement
is entered, and the name of the <tt class="docutils literal">__else__()</tt> method is unclear in
isolation, as numerous other Python statements include an <tt class="docutils literal">else</tt>
clause.</p>
</div>
</div>
<div class="section" id="iterator-finalisation-withdrawn">
<h1><a class="toc-backref" href="#id50">Iterator finalisation (WITHDRAWN)</a></h1>
<p>The ability to use user defined statements inside generators is likely
to increase the need for deterministic finalisation of iterators, as
resource management is pushed inside the generators, rather than being
handled externally as is currently the case.</p>
<p>The PEP currently suggests handling this by making all generators
statement templates, and using <tt class="docutils literal">with</tt> statements to handle
finalisation.  However, earlier versions of this PEP suggested the
following, more complex, solution, that allowed the <em>author</em> of a
generator to flag the need for finalisation, and have <tt class="docutils literal">for</tt> loops
deal with it automatically.  It is included here as a long, detailed
rejected option.</p>
<div class="section" id="iterator-protocol-addition-finish">
<h2><a class="toc-backref" href="#id51">Iterator protocol addition: <tt class="docutils literal">__finish__</tt></a></h2>
<p>An optional new method for iterators is proposed, called
<tt class="docutils literal">__finish__()</tt>.  It takes no arguments, and should not return
anything.</p>
<p>The <tt class="docutils literal">__finish__</tt> method is expected to clean up all resources the
iterator has open.  Iterators with a <tt class="docutils literal">__finish__()</tt> method are
called 'finishable iterators' for the remainder of the PEP.</p>
</div>
<div class="section" id="best-effort-finalisation">
<h2><a class="toc-backref" href="#id52">Best effort finalisation</a></h2>
<p>A finishable iterator should ensure that it provides a <tt class="docutils literal">__del__</tt>
method that also performs finalisation (e.g. by invoking the
<tt class="docutils literal">__finish__()</tt> method).  This allows Python to still make a best
effort at finalisation in the event that deterministic finalisation is
not applied to the iterator.</p>
</div>
<div class="section" id="deterministic-finalisation">
<h2><a class="toc-backref" href="#id53">Deterministic finalisation</a></h2>
<p>If the iterator used in a <tt class="docutils literal">for</tt> loop has a <tt class="docutils literal">__finish__()</tt> method,
the enhanced <tt class="docutils literal">for</tt> loop semantics will guarantee that that method
will be executed, regardless of the means of exiting the loop.  This
is important for iterator generators that utilise <a class="reference internal" href="#user-defined-statements">user defined
statements</a> or the now permitted <tt class="docutils literal">try</tt>/<tt class="docutils literal">finally</tt> statements, or
for new iterators that rely on timely finalisation to release
allocated resources (e.g. releasing a thread or database connection
back into a pool).</p>
</div>
<div class="section" id="for-loop-syntax">
<h2><a class="toc-backref" href="#id54"><tt class="docutils literal">for</tt> loop syntax</a></h2>
<p>No changes are suggested to <tt class="docutils literal">for</tt> loop syntax.  This is just to
define the statement parts needed for the description of the
semantics:</p>
<pre class="literal-block">
for VAR1 in EXPR1:
    BLOCK1
else:
    BLOCK2
</pre>
</div>
<div class="section" id="updated-for-loop-semantics">
<h2><a class="toc-backref" href="#id55">Updated <tt class="docutils literal">for</tt> loop semantics</a></h2>
<p>When the target iterator does not have a <tt class="docutils literal">__finish__()</tt> method, a
<tt class="docutils literal">for</tt> loop will execute as follows (i.e. no change from the status
quo):</p>
<pre class="literal-block">
itr = iter(EXPR1)
exhausted = False
while True:
    try:
        VAR1 = itr.next()
    except StopIteration:
        exhausted = True
        break
    BLOCK1
if exhausted:
    BLOCK2
</pre>
<p>When the target iterator has a <tt class="docutils literal">__finish__()</tt> method, a <tt class="docutils literal">for</tt> loop
will execute as follows:</p>
<pre class="literal-block">
itr = iter(EXPR1)
exhausted = False
try:
    while True:
        try:
            VAR1 = itr.next()
        except StopIteration:
            exhausted = True
            break
        BLOCK1
    if exhausted:
        BLOCK2
finally:
    itr.__finish__()
</pre>
<p>The implementation will need to take some care to avoid incurring the
<tt class="docutils literal">try</tt>/<tt class="docutils literal">finally</tt> overhead when the iterator does not have a
<tt class="docutils literal">__finish__()</tt> method.</p>
</div>
<div class="section" id="generator-iterator-finalisation-finish-method">
<h2><a class="toc-backref" href="#id56">Generator iterator finalisation: <tt class="docutils literal">__finish__()</tt> method</a></h2>
<p>When enabled with the appropriate decorator, generators will have a
<tt class="docutils literal">__finish__()</tt> method that raises <tt class="docutils literal">TerminateIteration</tt> in the
internal frame:</p>
<pre class="literal-block">
def __finish__(self):
    try:
        self._inject_exception(TerminateIteration)
    except TerminateIteration:
        pass
</pre>
<p>A decorator (e.g. <tt class="docutils literal">needs_finish()</tt>) is required to enable this
feature, so that existing generators (which are not expecting
finalisation) continue to work as expected.</p>
</div>
<div class="section" id="partial-iteration-of-finishable-iterators">
<h2><a class="toc-backref" href="#id57">Partial iteration of finishable iterators</a></h2>
<p>Partial iteration of a finishable iterator is possible, although it
requires some care to ensure the iterator is still finalised promptly
(it was made finishable for a reason!).  First, we need a class to
enable partial iteration of a finishable iterator by hiding the
iterator's <tt class="docutils literal">__finish__()</tt> method from the <tt class="docutils literal">for</tt> loop:</p>
<pre class="literal-block">
class partial_iter(object):

    def __init__(self, iterable):
        self.iter = iter(iterable)

    def __iter__(self):
        return self

    def next(self):
        return self.itr.next()
</pre>
<p>Secondly, an appropriate statement template is needed to ensure the
the iterator is finished eventually:</p>
<pre class="literal-block">
&#64;statement_template
def finishing(iterable):
      itr = iter(iterable)
      itr_finish = getattr(itr, &quot;__finish__&quot;, None)
      if itr_finish is None:
          yield itr
      else:
          try:
              yield partial_iter(itr)
          finally:
              itr_finish()
</pre>
<p>This can then be used as follows:</p>
<pre class="literal-block">
do finishing(finishable_itr) as itr:
    for header_item in itr:
        if end_of_header(header_item):
            break
        # process header item
    for body_item in itr:
        # process body item
</pre>
<p>Note that none of the above is needed for an iterator that is not
finishable - without a <tt class="docutils literal">__finish__()</tt> method, it will not be
promptly finalised by the <tt class="docutils literal">for</tt> loop, and hence inherently allows
partial iteration.  Allowing partial iteration of non-finishable
iterators as the default behaviour is a key element in keeping this
addition to the iterator protocol backwards compatible.</p>
</div>
</div>
<div class="section" id="acknowledgements">
<h1><a class="toc-backref" href="#id58">Acknowledgements</a></h1>
<p>The acknowledgements section for <a class="reference external" href="/dev/peps/pep-0340">PEP 340</a> applies, since this text grew
out of the discussion of that PEP, but additional thanks go to Michael
Hudson, Paul Moore and Guido van Rossum for writing <a class="reference external" href="/dev/peps/pep-0310">PEP 310</a> and <a class="reference external" href="/dev/peps/pep-0340">PEP
340</a> in the first place, and to (in no meaningful order) Fredrik Lundh,
Phillip J. Eby, Steven Bethard, Josiah Carlson, Greg Ewing, Tim
Delaney and Arnold deVos for prompting particular ideas that made
their way into this text.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id59">References</a></h1>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Reliable Acquisition/Release Pairs
(<a class="reference external" href="http://www.python.org/dev/peps/pep-0310/">http://www.python.org/dev/peps/pep-0310/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Anonymous block statements
(<a class="reference external" href="http://www.python.org/dev/peps/pep-0340/">http://www.python.org/dev/peps/pep-0340/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>Anonymous blocks, redux
(<a class="reference external" href="http://www.python.org/dev/peps/pep-0343/">http://www.python.org/dev/peps/pep-0343/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>Enhanced Iterators
(<a class="reference external" href="http://www.python.org/dev/peps/pep-0342/">http://www.python.org/dev/peps/pep-0342/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td>Generator Attributes and Exceptions
(<a class="reference external" href="http://www.python.org/dev/peps/pep-0288/">http://www.python.org/dev/peps/pep-0288/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td>Resource-Release Support for Generators
(<a class="reference external" href="http://www.python.org/dev/peps/pep-0325/">http://www.python.org/dev/peps/pep-0325/</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td>A rant against flow control macros
(<a class="reference external" href="http://blogs.msdn.com/oldnewthing/archive/2005/01/06/347666.aspx">http://blogs.msdn.com/oldnewthing/archive/2005/01/06/347666.aspx</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td>Why doesn't C# have a 'with' statement?
(<a class="reference external" href="http://msdn.microsoft.com/vcsharp/programming/language/ask/withstatement/">http://msdn.microsoft.com/vcsharp/programming/language/ask/withstatement/</a>)</td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id60">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
End: -->
</div>



      </div>

      
      <div id="footer">
	<div id="credits">
 	  <a href="/about/website">Website maintained by the Python community</a><br/>
	  <a href="http://www.xs4all.com/" title="Web and email hosting provided by xs4all, Netherlands">hosting by xs4all</a> /
	  <a href="http://www.timparkin.co.uk/" title="Design by Tim Parkin, Yorkshire man, photographer and developer">design by Tim Parkin</a>
	</div>
	Copyright &copy; 1990-2013, <a href='/psf/'>Python Software Foundation</a><br/>
	<a href="/about/legal">Legal Statements</a>
      </div>


    </div>
  </div>
</body>
</html>






