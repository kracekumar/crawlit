<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>PEP 339 -- Design of the CPython Compiler</title>
  <meta name="keywords" content="PEP 339 -- Design of the CPython Compiler" />
  <meta name="description" content="PEP 339 -- Design of the CPython Compiler" />
  <link rel="alternate" type="application/rss+xml" title="Community Events"
        href="http://www.python.org/channews.rdf" />
  <link rel="alternate" type="application/rss+xml" title="Python Recipes"
        href="http://aspn.activestate.com/ASPN/Cookbook/Python/index_rss" />
  <link rel="alternate" type="application/rss+xml" title="Usergroup News"
        href="http://python-groups.blogspot.com/feeds/posts/default" />
  <link rel="alternate" type="application/rss+xml" title="Python Screencasts"
        href="http://www.showmedo.com/latestVideoFeed/rss2.0?tag=python" />
  <link rel="alternate" type="application/rss+xml" title="Python Podcasts"
        href="http://www.awaretek.com/python/index.xml" />
  <link rel="alternate" type="application/rss+xml" title="Foundation News"
        href="http://feeds.feedburner.com/PythonSoftwareFoundationNews" />
  <link rel="alternate" type="application/rss+xml" title="Python Enhancement Proposals"
        href="http://www.python.org/dev/peps/peps.rss" />
  <link rel="alternate" type="application/rss+xml" title="Python Job Opportunities"
        href="http://www.python.org/community/jobs/jobs.rss" />
  <link rel="alternate" type="application/rss+xml" title="Reddit Feed of Python What's New Online"
        href="http://www.reddit.com/r/Python/.rss" />
  <link rel="alternate" type="application/rss+xml" title="Python Insider"
        href="http://feeds.feedburner.com/PythonInsider" />

  <link rel="stylesheet" type="text/css" media="screen" id="screen-switcher-stylesheet"
        href="/styles/screen-switcher-default.css" />
  <link rel="stylesheet" type="text/css" media="sc&#82;een"
        href="/styles/netscape4.css" />
  <link rel="stylesheet" type="text/css" media="print"
        href="/styles/print.css" />
  <link rel="alternate stylesheet" type="text/css" media="screen"
        href="/styles/largestyles.css" title="large text" />
  <link rel="alternate stylesheet" type="text/css" media="screen"
        href="/styles/defaultfonts.css" title="default fonts" />

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search under the www.python.org Domain"
        href="/search-pysite.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search within the Python Wiki"
        href="/search-pywiki.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search within Python Books at Google Book Search"
        href="/search-pybooks.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search within the Python Documentation"
        href="/search-pydocs.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search for a Module in the Standard Library"
        href="/search-pymodules.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search for Packages inside the Cheeseshop (PyPI)"
        href="/search-pycheese.xml"/>

  <link rel="search" type="application/opensearchdescription+xml"
        title="Search Archives of the Main Python Mailing List"
        href="/search-pythonlist.xml"/>

  <script type="text/javascript" src="/js/iotbs2-key-directors-load.js"></script>
  <script type="text/javascript" src="/js/iotbs2-directors.js"></script>
  <script type="text/javascript" src="/js/iotbs2-core.js"></script>

</head>


<body>
  <!-- Logo -->
  <h1 id="logoheader">
    <a href="/" id="logolink" accesskey="1"><img id="logo" src="/images/python-logo.gif" alt="homepage" border="0" /></a>
  </h1>
  <!-- Skip to Navigation -->
  <div class="skiptonav"><a href="#left-hand-navigation" accesskey="2"><img src="/images/trans.gif" id="skiptonav" alt="skip to navigation" border="0" /></a></div>
  <div class="skiptonav"><a href="#content-body" accesskey="3"><img src="/images/trans.gif" id="skiptocontent" alt="skip to content" border="0" /></a></div>
  <!-- Utility Menu -->
  <div id="utility-menu">
    <!-- Search Box -->
    <div id="searchbox">
      <form method="get" action="http://google.com/search" id="searchform" name="searchform">
        <div id="search">
          <input type="hidden" id="domains" name="domains" value="www.python.org" />
          <input type="hidden" id="sitesearch" name="sitesearch" value="www.python.org" />
          <input type="hidden" id="sourceid" name="sourceid" value="google-search" />
          <input type="text" class="input-text" name="q" id="q" />
          <input type="submit" value="search" class="input-button" name="submit" id="submit" />
          <a href="/search" class="reference">Advanced Search</a>
        </div>
      </form>
    </div>
    <div id="screen-switcher"></div>
  </div>

  <div id="left-hand-navigation">
    <!-- Main Menu -->
    <div id="menu">
      <ul class="level-one">
            <li>
          <a href="/about/" title="About The Python Language">About</a>
        </li>
            <li>
          <a href="/news/" title="Major Happenings Within the Python Community">News</a>
        </li>
            <li>
          <a href="/doc/" title="Tutorials, Library Reference, C API">Documentation</a>
        </li>
            <li>
          <a href="/download/" title="Start Running Python Under Windows, Mac, Linux and Others">Download</a>
        </li>
            <li>
          <a href="/getit/" title="Alternate Download page for China">ä¸è½½</a>
        </li>
            <li>
          <a href="/community/" title="Mailing Lists, Jobs, Conferences, SIGs, Online Chats">Community</a>
        </li>
            <li>
          <a href="/psf/" title="Python Software Foundation">Foundation</a>
        </li>
            <li>
          <a href="http://docs.python.org/devguide/" title="Development of the Python language and website">Core Development</a>
        </li>
      </ul>
    </div>

    <!-- Quick Links -->
    <h4><a style="margin-top:1.5em" href="http://wiki.python.org/moin/">Python Wiki</a></h4>
    <h4><a style="margin-top:1.5em" href="http://blog.python.org/">Python Insider Blog</a></h4>
    <h4><a style="margin-top:1.5em" href="http://wiki.python.org/moin/Python2orPython3">Python 2 or 3?</a></h4>
    <h4><a style="color:#D58228; margin-top:1.5em" href="/psf/donations/">Help Fund Python</a></h4>
    <div style="align:center; padding-top: 0.5em; padding-left: 1em">
      <a href="/psf/donations/"><img width="116" height="42" src="/images/donate.png" alt="" title="" /></a>
    </div>
    <div style="align:center; padding-top: 0.5em; padding-left: 2.5em">
            <a href="http://wiki.python.org/moin/Languages"><img
	      style="align:center"
              width="94" height="46"
	      src="/images/worldmap.jpg" alt="[Python resources in languages other than English]" /></a>
    </div>
    <div style="align:center; padding-top: 0.0em; padding-left: 0em">
       <h4><a href="http://wiki.python.org/moin/Languages">Non-English Resources</a></h4>
    </div>
    <div class="calendar">
        <iframe src="https://www.google.com/calendar/embed?title=Release%20Schedule&amp;showNav=0&amp;showDate=0&amp;showPrint=0&amp;showTabs=0&amp;showCalendars=0&amp;showTz=0&amp;mode=AGENDA&amp;height=300&amp;wkst=1&amp;bgcolor=%23FFFFFF&amp;src=b6v58qvojllt0i6ql654r1vh00%40group.calendar.google.com&amp;color=%23B1365F&amp;" style=" border-width:0 " width="180" height="300" frameborder="0" scrolling="no">
            <a href="http://www.google.com/calendar/ical/b6v58qvojllt0i6ql654r1vh00%40group.calendar.google.com/public/basic.ics">
                Python Release Schedule iCal Calendar
            </a>
        </iframe>
    </div>
    <div class="calendar">
        <iframe src="https://www.google.com/calendar/embed?title=Events%20Calendar&amp;showNav=0&amp;showDate=0&amp;showPrint=0&amp;showTabs=0&amp;showCalendars=0&amp;showTz=0&amp;mode=AGENDA&amp;height=300&amp;wkst=1&amp;bgcolor=%23FFFFFF&amp;src=j7gov1cmnqr9tvg14k621j7t5c%40group.calendar.google.com&amp;color=%23B1365F&amp;" style=" border-width:0 " width="180" height="300" frameborder="0" scrolling="no">
            <a href="http://www.google.com/calendar/ical/j7gov1cmnqr9tvg14k621j7t5c%40group.calendar.google.com/public/basic.ics">
                Python Events iCal Calendar
            </a>
        </iframe>
        <p class="level-one"><a href="http://pycon.org/#calendar">Add an event</a> to this calendar.</p>
    </div>
    <div class="calendar">
        <iframe src="https://www.google.com/calendar/embed?title=User%20Group%20Calendar&amp;showNav=0&amp;showDate=0&amp;showPrint=0&amp;showTabs=0&amp;showCalendars=0&amp;showTz=0&amp;mode=AGENDA&amp;height=300&amp;wkst=1&amp;bgcolor=%23FFFFFF&amp;src=3haig2m9msslkpf2tn1h56nn9g%40group.calendar.google.com&amp;color=%23125A12&amp;" style=" border-width:0 " width="180" height="300" frameborder="0" scrolling="no">
            <a href="http://www.google.com/calendar/ical/3haig2m9msslkpf2tn1h56nn9g%40group.calendar.google.com/public/basic.ics">
                Python User Group iCal Calendar
            </a>
        </iframe>
        <p class="level-one"><a href="http://pycon.org/#calendar">Add an event</a> to this calendar.</p>
    </div>
  </div>

  <div id="content-body">
    <div id="body-main">
      <div id="content">
        
          <div id="breadcrumb">
               <a href="/dev/peps/">PEP Index</a>
               <span class="breadcrumb-separator">&gt;</span>
            
            PEP 339 -- Design of the CPython Compiler
          </div>



        <!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/dev/peps/pep-0001 for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">339</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Design of the CPython Compiler</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">c0d120cf0aac</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="http://hg.python.org/peps/file/tip/pep-0339.txt">2013-11-10 15:00:13 -0500 (Sun, 10 Nov 2013)</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Brett Cannon &lt;brett&#32;&#97;t&#32;python.org&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Withdrawn</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Informational</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">02-Feb-2005</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id11">Abstract</a></li>
<li><a class="reference internal" href="#parse-trees" id="id12">Parse Trees</a></li>
<li><a class="reference internal" href="#abstract-syntax-trees-ast" id="id13">Abstract Syntax Trees (AST)</a></li>
<li><a class="reference internal" href="#memory-management" id="id14">Memory Management</a></li>
<li><a class="reference internal" href="#parse-tree-to-ast" id="id15">Parse Tree to AST</a></li>
<li><a class="reference internal" href="#control-flow-graphs" id="id16">Control Flow Graphs</a></li>
<li><a class="reference internal" href="#ast-to-cfg-to-bytecode" id="id17">AST to CFG to Bytecode</a></li>
<li><a class="reference internal" href="#introducing-new-bytecode" id="id18">Introducing New Bytecode</a></li>
<li><a class="reference internal" href="#code-objects" id="id19">Code Objects</a></li>
<li><a class="reference internal" href="#important-files" id="id20">Important Files</a></li>
<li><a class="reference internal" href="#known-compiler-related-experiments" id="id21">Known Compiler-related Experiments</a></li>
<li><a class="reference internal" href="#references" id="id22">References</a></li>
</ul>
</div>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">This PEP has been withdrawn and moved to the Python
developer's guide.</p>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id11">Abstract</a></h1>
<p>Historically (through 2.4), compilation from source code to bytecode
involved two steps:</p>
<ol class="arabic simple">
<li>Parse the source code into a parse tree (Parser/pgen.c)</li>
<li>Emit bytecode based on the parse tree (Python/compile.c)</li>
</ol>
<p>Historically, this is not how a standard compiler works.  The usual
steps for compilation are:</p>
<ol class="arabic simple">
<li>Parse source code into a parse tree (Parser/pgen.c)</li>
<li>Transform parse tree into an Abstract Syntax Tree (Python/ast.c)</li>
<li>Transform AST into a Control Flow Graph (Python/compile.c)</li>
<li>Emit bytecode based on the Control Flow Graph (Python/compile.c)</li>
</ol>
<p>Starting with Python 2.5, the above steps are now used.  This change
was done to simplify compilation by breaking it into three steps.
The purpose of this document is to outline how the latter three steps
of the process works.</p>
<p>This document does not touch on how parsing works beyond what is needed
to explain what is needed for compilation.  It is also not exhaustive
in terms of the how the entire system works.  You will most likely need
to read some source to have an exact understanding of all details.</p>
</div>
<div class="section" id="parse-trees">
<h1><a class="toc-backref" href="#id12">Parse Trees</a></h1>
<p>Python's parser is an LL(1) parser mostly based off of the
implementation laid out in the Dragon Book <a class="citation-reference" href="#aho86" id="id1">[Aho86]</a>.</p>
<p>The grammar file for Python can be found in Grammar/Grammar with the
numeric value of grammar rules are stored in Include/graminit.h.  The
numeric values for types of tokens (literal tokens, such as <tt class="docutils literal">:</tt>,
numbers, etc.) are kept in Include/token.h).  The parse tree made up of
<tt class="docutils literal">node *</tt> structs (as defined in Include/node.h).</p>
<p>Querying data from the node structs can be done with the following
macros (which are all defined in Include/token.h):</p>
<ul>
<li><dl class="first docutils">
<dt><tt class="docutils literal">CHILD(node *, int)</tt></dt>
<dd><p class="first last">Returns the nth child of the node using zero-offset indexing</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">RCHILD(node *, int)</tt></dt>
<dd><p class="first last">Returns the nth child of the node from the right side; use
negative numbers!</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">NCH(node *)</tt></dt>
<dd><p class="first last">Number of children the node has</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">STR(node *)</tt></dt>
<dd><p class="first last">String representation of the node; e.g., will return <tt class="docutils literal">:</tt> for a
COLON token</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">TYPE(node *)</tt></dt>
<dd><p class="first last">The type of node as specified in <tt class="docutils literal">Include/graminit.h</tt></p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">REQ(node *, TYPE)</tt></dt>
<dd><p class="first last">Assert that the node is the type that is expected</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">LINENO(node *)</tt></dt>
<dd><p class="first last">retrieve the line number of the source code that led to the
creation of the parse rule; defined in Python/ast.c</p>
</dd>
</dl>
</li>
</ul>
<p>To tie all of this example, consider the rule for 'while':</p>
<pre class="literal-block">
while_stmt: 'while' test ':' suite ['else' ':' suite]
</pre>
<p>The node representing this will have <tt class="docutils literal">TYPE(node) == while_stmt</tt> and
the number of children can be 4 or 7 depending on if there is an 'else'
statement.  To access what should be the first ':' and require it be an
actual ':' token, <cite>(REQ(CHILD(node, 2), COLON)`</cite>.</p>
</div>
<div class="section" id="abstract-syntax-trees-ast">
<h1><a class="toc-backref" href="#id13">Abstract Syntax Trees (AST)</a></h1>
<p>The abstract syntax tree (AST) is a high-level representation of the
program structure without the necessity of containing the source code;
it can be thought of as an abstract representation of the source code.  The
specification of the AST nodes is specified using the Zephyr Abstract
Syntax Definition Language (ASDL) <a class="citation-reference" href="#wang97" id="id2">[Wang97]</a>.</p>
<p>The definition of the AST nodes for Python is found in the file
Parser/Python.asdl .</p>
<p>Each AST node (representing statements, expressions, and several
specialized types, like list comprehensions and exception handlers) is
defined by the ASDL.  Most definitions in the AST correspond to a
particular source construct, such as an 'if' statement or an attribute
lookup.  The definition is independent of its realization in any
particular programming language.</p>
<p>The following fragment of the Python ASDL construct demonstrates the
approach and syntax:</p>
<pre class="literal-block">
module Python
{
      stmt = FunctionDef(identifier name, arguments args, stmt* body,
                          expr* decorators)
            | Return(expr? value) | Yield(expr value)
            attributes (int lineno)
}
</pre>
<p>The preceding example describes three different kinds of statements;
function definitions, return statements, and yield statements.  All
three kinds are considered of type stmt as shown by '|' separating the
various kinds.  They all take arguments of various kinds and amounts.</p>
<p>Modifiers on the argument type specify the number of values needed; '?'
means it is optional, '*' means 0 or more, no modifier means only one
value for the argument and it is required.  FunctionDef, for instance,
takes an identifier for the name, 'arguments' for args, zero or more
stmt arguments for 'body', and zero or more expr arguments for
'decorators'.</p>
<p>Do notice that something like 'arguments', which is a node type, is
represented as a single AST node and not as a sequence of nodes as with
stmt as one might expect.</p>
<p>All three kinds also have an 'attributes' argument; this is shown by the
fact that 'attributes' lacks a '|' before it.</p>
<p>The statement definitions above generate the following C structure type:</p>
<pre class="literal-block">
typedef struct _stmt *stmt_ty;

struct _stmt {
      enum { FunctionDef_kind=1, Return_kind=2, Yield_kind=3 } kind;
      union {
              struct {
                      identifier name;
                      arguments_ty args;
                      asdl_seq *body;
              } FunctionDef;

              struct {
                      expr_ty value;
              } Return;

              struct {
                      expr_ty value;
              } Yield;
      } v;
      int lineno;
 }
</pre>
<p>Also generated are a series of constructor functions that allocate (in
this case) a stmt_ty struct with the appropriate initialization.  The
'kind' field specifies which component of the union is initialized.  The
FunctionDef() constructor function sets 'kind' to FunctionDef_kind and
initializes the 'name', 'args', 'body', and 'attributes' fields.</p>
</div>
<div class="section" id="memory-management">
<h1><a class="toc-backref" href="#id14">Memory Management</a></h1>
<p>Before discussing the actual implementation of the compiler, a discussion of
how memory is handled is in order.  To make memory management simple, an arena
is used.  This means that a memory is pooled in a single location for easy
allocation and removal.  What this gives us is the removal of explicit memory
deallocation.  Because memory allocation for all needed memory in the compiler
registers that memory with the arena, a single call to free the arena is all
that is needed to completely free all memory used by the compiler.</p>
<p>In general, unless you are working on the critical core of the compiler, memory
management can be completely ignored.  But if you are working at either the
very beginning of the compiler or the end, you need to care about how the arena
works.  All code relating to the arena is in either Include/pyarena.h or
Python/pyarena.c .</p>
<p>PyArena_New() will create a new arena.  The returned PyArena structure will
store pointers to all memory given to it.  This does the bookkeeping of what
memory needs to be freed when the compiler is finished with the memory it used.
That freeing is done with PyArena_Free().  This needs to only be called in
strategic areas where the compiler exits.</p>
<p>As stated above, in general you should not have to worry about memory
management when working on the compiler.  The technical details have been
designed to be hidden from you for most cases.</p>
<p>The only exception comes about when managing a PyObject.  Since the rest
of Python uses reference counting, there is extra support added
to the arena to cleanup each PyObject that was allocated.  These cases
are very rare.  However, if you've allocated a PyObject, you must tell
the arena about it by calling PyArena_AddPyObject().</p>
</div>
<div class="section" id="parse-tree-to-ast">
<h1><a class="toc-backref" href="#id15">Parse Tree to AST</a></h1>
<p>The AST is generated from the parse tree (see Python/ast.c) using the
function <tt class="docutils literal">PyAST_FromNode()</tt>.</p>
<p>The function begins a tree walk of the parse tree, creating various AST
nodes as it goes along.  It does this by allocating all new nodes it
needs, calling the proper AST node creation functions for any required
supporting functions, and connecting them as needed.</p>
<p>Do realize that there is no automated nor symbolic connection between
the grammar specification and the nodes in the parse tree.  No help is
directly provided by the parse tree as in yacc.</p>
<p>For instance, one must keep track of which node in the parse tree
one is working with (e.g., if you are working with an 'if' statement
you need to watch out for the ':' token to find the end of the conditional).</p>
<p>The functions called to generate AST nodes from the parse tree all have
the name ast_for_xx where xx is what the grammar rule that the function
handles (alias_for_import_name is the exception to this).  These in turn
call the constructor functions as defined by the ASDL grammar and
contained in Python/Python-ast.c (which was generated by
Parser/asdl_c.py) to create the nodes of the AST.  This all leads to a
sequence of AST nodes stored in asdl_seq structs.</p>
<p>Function and macros for creating and using <tt class="docutils literal">asdl_seq *</tt> types as found
in Python/asdl.c and Include/asdl.h:</p>
<ul>
<li><dl class="first docutils">
<dt><tt class="docutils literal">asdl_seq_new()</tt></dt>
<dd><p class="first last">Allocate memory for an asdl_seq for the specified length</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">asdl_seq_GET()</tt></dt>
<dd><p class="first last">Get item held at a specific position in an asdl_seq</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">asdl_seq_SET()</tt></dt>
<dd><p class="first last">Set a specific index in an asdl_seq to the specified value</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">asdl_seq_LEN(asdl_seq *)</tt></dt>
<dd><p class="first last">Return the length of an asdl_seq</p>
</dd>
</dl>
</li>
</ul>
<p>If you are working with statements, you must also worry about keeping
track of what line number generated the statement.  Currently the line
number is passed as the last parameter to each stmt_ty function.</p>
</div>
<div class="section" id="control-flow-graphs">
<h1><a class="toc-backref" href="#id16">Control Flow Graphs</a></h1>
<p>A control flow graph (often referenced by its acronym, CFG) is a
directed graph that models the flow of a program using basic blocks that
contain the intermediate representation (abbreviated &quot;IR&quot;, and in this
case is Python bytecode) within the blocks.  Basic blocks themselves are
a block of IR that has a single entry point but possibly multiple exit
points.  The single entry point is the key to basic blocks; it all has
to do with jumps.  An entry point is the target of something that
changes control flow (such as a function call or a jump) while exit
points are instructions that would change the flow of the program (such
as jumps and 'return' statements).  What this means is that a basic
block is a chunk of code that starts at the entry point and runs to an
exit point or the end of the block.</p>
<p>As an example, consider an 'if' statement with an 'else' block.  The
guard on the 'if' is a basic block which is pointed to by the basic
block containing the code leading to the 'if' statement.  The 'if'
statement block contains jumps (which are exit points) to the true body
of the 'if' and the 'else' body (which may be NULL), each of which are
their own basic blocks.  Both of those blocks in turn point to the
basic block representing the code following the entire 'if' statement.</p>
<p>CFGs are usually one step away from final code output.  Code is directly
generated from the basic blocks (with jump targets adjusted based on the
output order) by doing a post-order depth-first search on the CFG
following the edges.</p>
</div>
<div class="section" id="ast-to-cfg-to-bytecode">
<h1><a class="toc-backref" href="#id17">AST to CFG to Bytecode</a></h1>
<p>With the AST created, the next step is to create the CFG. The first step
is to convert the AST to Python bytecode without having jump targets
resolved to specific offsets (this is calculated when the CFG goes to
final bytecode). Essentially, this transforms the AST into Python
bytecode with control flow represented by the edges of the CFG.</p>
<p>Conversion is done in two passes.  The first creates the namespace
(variables can be classified as local, free/cell for closures, or
global).  With that done, the second pass essentially flattens the CFG
into a list and calculates jump offsets for final output of bytecode.</p>
<p>The conversion process is initiated by a call to the function
<tt class="docutils literal">PyAST_Compile()</tt> in Python/compile.c .  This function does both the
conversion of the AST to a CFG and
outputting final bytecode from the CFG.  The AST to CFG step is handled
mostly by two functions called by PyAST_Compile(); PySymtable_Build() and
compiler_mod() .  The former is in Python/symtable.c while the latter is in
Python/compile.c .</p>
<p>PySymtable_Build() begins by entering the starting code block for the
AST (passed-in) and then calling the proper symtable_visit_xx function
(with xx being the AST node type).  Next, the AST tree is walked with
the various code blocks that delineate the reach of a local variable
as blocks are entered and exited using symtable_enter_block() and
symtable_exit_block(), respectively.</p>
<p>Once the symbol table is created, it is time for CFG creation, whose
code is in Python/compile.c .  This is handled by several functions
that break the task down by various AST node types.  The functions are
all named compiler_visit_xx where xx is the name of the node type (such
as stmt, expr, etc.).  Each function receives a <tt class="docutils literal">struct compiler *</tt>
and xx_ty where xx is the AST node type.  Typically these functions
consist of a large 'switch' statement, branching based on the kind of
node type passed to it.  Simple things are handled inline in the
'switch' statement with more complex transformations farmed out to other
functions named compiler_xx with xx being a descriptive name of what is
being handled.</p>
<p>When transforming an arbitrary AST node, use the VISIT() macro.
The appropriate compiler_visit_xx function is called, based on the value
passed in for &lt;node type&gt; (so <tt class="docutils literal">VISIT(c, expr, node)</tt> calls
<tt class="docutils literal">compiler_visit_expr(c, node)</tt>).  The VISIT_SEQ macro is very similar,
but is called on AST node sequences (those values that were created as
arguments to a node that used the '*' modifier).  There is also
VISIT_SLICE() just for handling slices.</p>
<p>Emission of bytecode is handled by the following macros:</p>
<ul>
<li><dl class="first docutils">
<dt><tt class="docutils literal">ADDOP()</tt></dt>
<dd><p class="first last">add a specified opcode</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">ADDOP_I()</tt></dt>
<dd><p class="first last">add an opcode that takes an argument</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">ADDOP_O(struct compiler *c, int op, PyObject *type, PyObject *obj)</tt></dt>
<dd><p class="first last">add an opcode with the proper argument based on the position of the
specified PyObject in PyObject sequence object, but with no handling of
mangled names; used for when you
need to do named lookups of objects such as globals, consts, or
parameters where name mangling is not possible and the scope of the
name is known</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">ADDOP_NAME()</tt></dt>
<dd><p class="first last">just like ADDOP_O, but name mangling is also handled; used for
attribute loading or importing based on name</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">ADDOP_JABS()</tt></dt>
<dd><p class="first last">create an absolute jump to a basic block</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">ADDOP_JREL()</tt></dt>
<dd><p class="first last">create a relative jump to a basic block</p>
</dd>
</dl>
</li>
</ul>
<p>Several helper functions that will emit bytecode and are named
compiler_xx() where xx is what the function helps with (list, boolop,
etc.).  A rather useful one is compiler_nameop().
This function looks up the scope of a variable and, based on the
expression context, emits the proper opcode to load, store, or delete
the variable.</p>
<p>As for handling the line number on which a statement is defined, is
handled by compiler_visit_stmt() and thus is not a worry.</p>
<p>In addition to emitting bytecode based on the AST node, handling the
creation of basic blocks must be done.  Below are the macros and
functions used for managing basic blocks:</p>
<ul>
<li><dl class="first docutils">
<dt><tt class="docutils literal">NEW_BLOCK()</tt></dt>
<dd><p class="first last">create block and set it as current</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">NEXT_BLOCK()</tt></dt>
<dd><p class="first last">basically NEW_BLOCK() plus jump from current block</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal">compiler_new_block()</tt></dt>
<dd><p class="first last">create a block but don't use it (used for generating jumps)</p>
</dd>
</dl>
</li>
</ul>
<p>Once the CFG is created, it must be flattened and then final emission of
bytecode occurs.  Flattening is handled using a post-order depth-first
search.  Once flattened, jump offsets are backpatched based on the
flattening and then a PyCodeObject file is created.  All of this is
handled by calling assemble() .</p>
</div>
<div class="section" id="introducing-new-bytecode">
<h1><a class="toc-backref" href="#id18">Introducing New Bytecode</a></h1>
<p>Sometimes a new feature requires a new opcode.  But adding new bytecode is
not as simple as just suddenly introducing new bytecode in the AST -&gt;
bytecode step of the compiler.  Several pieces of code throughout Python depend
on having correct information about what bytecode exists.</p>
<p>First, you must choose a name and a unique identifier number.  The official
list of bytecode can be found in Include/opcode.h .  If the opcode is to take
an argument, it must be given a unique number greater than that assigned to
<tt class="docutils literal">HAVE_ARGUMENT</tt> (as found in Include/opcode.h).</p>
<p>Once the name/number pair
has been chosen and entered in Include/opcode.h, you must also enter it into
Lib/opcode.py and Doc/library/dis.rst .</p>
<p>With a new bytecode you must also change what is called the magic number for
.pyc files.  The variable <tt class="docutils literal">MAGIC</tt> in Python/import.c contains the number.
Changing this number will lead to all .pyc files with the old MAGIC
to be recompiled by the interpreter on import.</p>
<p>Finally, you need to introduce the use of the new bytecode.  Altering
Python/compile.c and Python/ceval.c will be the primary places to change.
But you will also need to change the 'compiler' package.  The key files
to do that are Lib/compiler/pyassem.py and Lib/compiler/pycodegen.py .</p>
<p>If you make a change here that can affect the output of bytecode that
is already in existence and you do not change the magic number constantly, make
sure to delete your old .py(c|o) files!  Even though you will end up changing
the magic number if you change the bytecode, while you are debugging your work
you will be changing the bytecode output without constantly bumping up the
magic number.  This means you end up with stale .pyc files that will not be
recreated.  Running
<tt class="docutils literal">find . <span class="pre">-name</span> <span class="pre">'*.py[co]'</span> <span class="pre">-exec</span> rm <span class="pre">-f</span> {} ';'</tt> should delete all .pyc files you
have, forcing new ones to be created and thus allow you test out your new
bytecode properly.</p>
</div>
<div class="section" id="code-objects">
<h1><a class="toc-backref" href="#id19">Code Objects</a></h1>
<p>The result of <tt class="docutils literal">PyAST_Compile()</tt> is a PyCodeObject which is defined in
Include/code.h .  And with that you now have executable Python bytecode!</p>
<p>The code objects (byte code) is executed in Python/ceval.c .  This file
will also need a new case statement for the new opcode in the big switch
statement in PyEval_EvalFrameEx().</p>
</div>
<div class="section" id="important-files">
<h1><a class="toc-backref" href="#id20">Important Files</a></h1>
<ul>
<li><p class="first">Parser/</p>
<blockquote>
<ul>
<li><dl class="first docutils">
<dt>Python.asdl</dt>
<dd><p class="first last">ASDL syntax file</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>asdl.py</dt>
<dd><p class="first last">&quot;An implementation of the Zephyr Abstract Syntax Definition
Language.&quot;  Uses <a class="reference external" href="http://pages.cpsc.ucalgary.ca/~aycock/spark/">SPARK</a> <a class="footnote-reference" href="#id8" id="id9">[5]</a> to parse the ASDL files.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>asdl_c.py</dt>
<dd><p class="first last">&quot;Generate C code from an ASDL description.&quot;  Generates
Python/Python-ast.c and Include/Python-ast.h .</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>spark.py</dt>
<dd><p class="first last"><a class="reference external" href="http://pages.cpsc.ucalgary.ca/~aycock/spark/">SPARK</a> <a class="footnote-reference" href="#id8" id="id10">[5]</a> parser generator</p>
</dd>
</dl>
</li>
</ul>
</blockquote>
</li>
<li><p class="first">Python/</p>
<blockquote>
<ul>
<li><dl class="first docutils">
<dt>Python-ast.c</dt>
<dd><p class="first last">Creates C structs corresponding to the ASDL types.  Also
contains code for marshaling AST nodes (core ASDL types have
marshaling code in asdl.c).  &quot;File automatically generated by
Parser/asdl_c.py&quot;.  This file must be committed separately
after every grammar change is committed since the __version__
value is set to the latest grammar change revision number.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>asdl.c</dt>
<dd><p class="first last">Contains code to handle the ASDL sequence type.  Also has code
to handle marshalling the core ASDL types, such as number and
identifier.  used by Python-ast.c for marshaling AST nodes.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>ast.c</dt>
<dd><p class="first last">Converts Python's parse tree into the abstract syntax tree.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>ceval.c</dt>
<dd><p class="first last">Executes byte code (aka, eval loop).</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>compile.c</dt>
<dd><p class="first last">Emits bytecode based on the AST.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>symtable.c</dt>
<dd><p class="first last">Generates a symbol table from AST.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>pyarena.c</dt>
<dd><p class="first last">Implementation of the arena memory manager.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>import.c</dt>
<dd><p class="first last">Home of the magic number (named <tt class="docutils literal">MAGIC</tt>) for bytecode versioning</p>
</dd>
</dl>
</li>
</ul>
</blockquote>
</li>
<li><p class="first">Include/</p>
<blockquote>
<ul>
<li><dl class="first docutils">
<dt>Python-ast.h</dt>
<dd><p class="first last">Contains the actual definitions of the C structs as generated by
Python/Python-ast.c .
&quot;Automatically generated by Parser/asdl_c.py&quot;.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>asdl.h</dt>
<dd><p class="first last">Header for the corresponding Python/ast.c .</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>ast.h</dt>
<dd><p class="first last">Declares PyAST_FromNode() external (from Python/ast.c).</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>code.h</dt>
<dd><p class="first last">Header file for Objects/codeobject.c; contains definition of
PyCodeObject.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>symtable.h</dt>
<dd><p class="first last">Header for Python/symtable.c .  struct symtable and
PySTEntryObject are defined here.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>pyarena.h</dt>
<dd><p class="first last">Header file for the corresponding Python/pyarena.c .</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>opcode.h</dt>
<dd><p class="first last">Master list of bytecode; if this file is modified you must modify
several other files accordingly (see &quot;<a class="reference internal" href="#introducing-new-bytecode">Introducing New Bytecode</a>&quot;)</p>
</dd>
</dl>
</li>
</ul>
</blockquote>
</li>
<li><p class="first">Objects/</p>
<blockquote>
<ul>
<li><dl class="first docutils">
<dt>codeobject.c</dt>
<dd><p class="first last">Contains PyCodeObject-related code (originally in
Python/compile.c).</p>
</dd>
</dl>
</li>
</ul>
</blockquote>
</li>
<li><p class="first">Lib/</p>
<blockquote>
<ul>
<li><dl class="first docutils">
<dt>opcode.py</dt>
<dd><p class="first last">One of the files that must be modified if Include/opcode.h is.</p>
</dd>
</dl>
</li>
<li><p class="first">compiler/</p>
<blockquote>
<ul>
<li><dl class="first docutils">
<dt>pyassem.py</dt>
<dd><p class="first last">One of the files that must be modified if Include/opcode.h is
changed.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>pycodegen.py</dt>
<dd><p class="first last">One of the files that must be modified if Include/opcode.h is
changed.</p>
</dd>
</dl>
</li>
</ul>
</blockquote>
</li>
</ul>
</blockquote>
</li>
</ul>
</div>
<div class="section" id="known-compiler-related-experiments">
<h1><a class="toc-backref" href="#id21">Known Compiler-related Experiments</a></h1>
<p>This section lists known experiments involving the compiler (including
bytecode).</p>
<p>Skip Montanaro presented a paper at a Python workshop on a peephole optimizer
<a class="footnote-reference" href="#skip-peephole" id="id3">[1]</a>.</p>
<p>Michael Hudson has a non-active SourceForge project named Bytecodehacks
<a class="footnote-reference" href="#bytecodehacks" id="id4">[2]</a> that provides functionality for playing with bytecode
directly.</p>
<p>An opcode to combine the functionality of LOAD_ATTR/CALL_FUNCTION was created
named CALL_ATTR <a class="footnote-reference" href="#call-attr" id="id5">[3]</a>.  Currently only works for classic classes and
for new-style classes rough benchmarking showed an actual slowdown thanks to
having to support both classic and new-style classes.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id22">References</a></h1>
<table class="docutils citation" frame="void" id="aho86" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[Aho86]</a></td><td>Alfred V. Aho, Ravi Sethi, Jeffrey D. Ullman.
<cite>Compilers: Principles, Techniques, and Tools</cite>,
<a class="reference external" href="http://www.amazon.com/exec/obidos/tg/detail/-/0201100886/104-0162389-6419108">http://www.amazon.com/exec/obidos/tg/detail/-/0201100886/104-0162389-6419108</a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="wang97" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[Wang97]</a></td><td>Daniel C. Wang, Andrew W. Appel, Jeff L. Korn, and Chris
S. Serra.  <a class="reference external" href="http://www.cs.princeton.edu/research/techreps/TR-554-97">The Zephyr Abstract Syntax Description Language.</a> <a class="footnote-reference" href="#id6" id="id7">[4]</a>
In Proceedings of the Conference on Domain-Specific Languages, pp.
213--227, 1997.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="skip-peephole" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>Skip Montanaro's Peephole Optimizer Paper
(<a class="reference external" href="http://www.foretec.com/python/workshops/1998-11/proceedings/papers/montanaro/montanaro.html">http://www.foretec.com/python/workshops/1998-11/proceedings/papers/montanaro/montanaro.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="bytecodehacks" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td>Bytecodehacks Project
(<a class="reference external" href="http://bytecodehacks.sourceforge.net/bch-docs/bch/index.html">http://bytecodehacks.sourceforge.net/bch-docs/bch/index.html</a>)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="call-attr" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td>CALL_ATTR opcode
(<a class="reference external" href="http://www.python.org/sf/709744">http://www.python.org/sf/709744</a>)</td></tr>
</tbody>
</table>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 80
End: -->
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[4]</a></td><td><a class="reference external" href="http://www.cs.princeton.edu/research/techreps/TR-554-97">http://www.cs.princeton.edu/research/techreps/TR-554-97</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[5]</td><td><em>(<a class="fn-backref" href="#id9">1</a>, <a class="fn-backref" href="#id10">2</a>)</em> <a class="reference external" href="http://pages.cpsc.ucalgary.ca/~aycock/spark/">http://pages.cpsc.ucalgary.ca/~aycock/spark/</a></td></tr>
</tbody>
</table>
</div>



      </div>

      
      <div id="footer">
	<div id="credits">
 	  <a href="/about/website">Website maintained by the Python community</a><br/>
	  <a href="http://www.xs4all.com/" title="Web and email hosting provided by xs4all, Netherlands">hosting by xs4all</a> /
	  <a href="http://www.timparkin.co.uk/" title="Design by Tim Parkin, Yorkshire man, photographer and developer">design by Tim Parkin</a>
	</div>
	Copyright &copy; 1990-2013, <a href='/psf/'>Python Software Foundation</a><br/>
	<a href="/about/legal">Legal Statements</a>
      </div>


    </div>
  </div>
</body>
</html>






